<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSPORT Football</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .card-hover:hover {
            transform: scale(1.01);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        ::-webkit-scrollbar { width: 8px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .outcome-homeWin { background-color: #e8f5f9; border-left: 4px solid #4caf50; }
        .outcome-awayWin { background-color: #ffebee; border-left: 4px solid #f44336; }
        .outcome-draw { background-color: #fff3e0; border-left: 4px solid #ff9800; }

        .tab { transition: all 0.2s ease-in-out; }
        .tab.active { background-color: white; border-color: #e5e7eb; border-bottom-color: white; transform: translateY(-2px); }
        .tab-panel, .ai-tab-panel { display: none; }
        .tab-panel.active, .ai-tab-panel.active { display: block; }
        
        #stats-modal { transition: opacity 0.3s ease-in-out; }
        #stats-modal.hidden { pointer-events: none; }
        
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        
        .scrollable-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #4b5563 #1f2937; /* Firefox */
        }
        .scrollable-tabs::-webkit-scrollbar-track { background: #1f2937; }
        .scrollable-tabs::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }


        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="text-slate-800 p-4">

    <!-- App Page -->
    <main id="app-page" class="w-full max-w-4xl bg-white rounded-2xl shadow-lg border border-gray-200 p-6 space-y-6 mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
             <div class="text-left">
                 <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Odds Elemző</h1>
                 <p id="app-welcome-user" class="text-slate-500 mt-1">Helyi Mód</p>
             </div>
             <div class="text-left sm:text-right space-y-2 w-full sm:w-auto">
                 <div class="flex items-center justify-start sm:justify-end space-x-2 flex-wrap gap-2">
                     <button id="export-json-btn" class="bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-gray-700 flex items-center space-x-2 text-sm">
                         <span>Export JSON</span>
                     </button>
                      <button id="export-csv-btn" class="bg-teal-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-teal-700 flex items-center space-x-2 text-sm">
                         <span>Export CSV</span>
                     </button>
                     <button id="import-data-btn" class="bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-gray-700 flex items-center space-x-2 text-sm">
                         <span>Import</span>
                     </button>
                     <input type="file" id="import-file-input" class="hidden" accept=".json">
                     <button id="open-stats-btn" class="bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-blue-700 flex items-center space-x-2 text-sm">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                         <span>Statisztika</span>
                     </button>
                 </div>
                  <p id="import-status" class="text-xs text-gray-500 h-4 mt-2"></p>
             </div>
        </div>

        <div id="main-grid" class="grid grid-cols-1 lg:gap-6 space-y-6 lg:space-y-0">
            <div class="bg-gray-800 text-white p-5 rounded-xl border border-gray-700 space-y-4 flex flex-col">
                <h2 class="text-lg font-semibold text-center">AI Elemző</h2>
                <div class="flex border-b border-gray-600">
                    <div id="ai-tabs-container" class="flex items-center scrollable-tabs"></div>
                    <button id="add-ai-tab-btn" class="ml-2 px-3 py-1 text-lg font-bold text-gray-400 hover:bg-gray-700 rounded-full transition shrink-0">+</button>
                </div>
                <div id="ai-panels-container"></div>
            </div>
        </div>

        <div id="database-section">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Lezárt Meccsek (Adatbázis)</h2>
            <div id="log-list" class="space-y-3"></div>
        </div>
    </main>

    <!-- Statisztika Modal -->
    <div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-3xl max-h-[90vh] rounded-xl shadow-2xl flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                 <div class="flex items-center gap-4">
                     <h2 class="text-xl font-bold text-slate-800">Modellek Teljesítménye</h2>
                     <button id="reset-stats-btn" class="bg-red-600 text-white font-semibold py-1 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-red-700 flex items-center space-x-2 text-xs">
                         <span>Statisztika Törlése</span>
                     </button>
                </div>
                <button id="close-stats-btn" class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="stats-content" class="p-6 overflow-y-auto space-y-6"></div>
        </div>
    </div>

<script>
    // --- APP ELEMENTS ---
    const appWelcomeUser = document.getElementById('app-welcome-user');
    const mainGrid = document.getElementById('main-grid');
    const databaseSection = document.getElementById('database-section');
    const aiTabsContainer = document.getElementById('ai-tabs-container');
    const aiPanelsContainer = document.getElementById('ai-panels-container');
    const addAITabBtn = document.getElementById('add-ai-tab-btn');
    const logListDiv = document.getElementById('log-list');
    const statsModal = document.getElementById('stats-modal');
    const openStatsBtn = document.getElementById('open-stats-btn');
    const closeStatsBtn = document.getElementById('close-stats-btn');
    const statsContent = document.getElementById('stats-content');
    const exportJsonBtn = document.getElementById('export-json-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFileInput = document.getElementById('import-file-input');
    const importStatus = document.getElementById('import-status');
    const resetStatsBtn = document.getElementById('reset-stats-btn');


    // --- APP STATE ---
    let logs = [];
    let predictionsLog = [];
    let activeAITabId = null;
    let analysisTimeout;

    // --- MATH & AI MODELS ---

    const model_Odds_Elemzo = (home, draw, away) => {
        const MIN_LOGS_TOTAL = 10;
        const NUM_MATCHES_TO_ANALYZE = 20;

        if (logs.length < MIN_LOGS_TOTAL) {
            return {
                prediction: 'uncertain',
                predictedScore: '?-?',
                predictedOverUnder15: 'uncertain',
                predictedOverUnder25: 'uncertain',
                reason: `Nincs elég adat (minimum ${MIN_LOGS_TOTAL} meccs) a historikus odds elemzéshez.`,
                pattern: 'Odds Elemző',
                avgTotalGoals: undefined,
                confidence: 'Alacsony'
            };
        }

        const matchesWithDistance = logs.map(l => {
            const distance = Math.sqrt(Math.pow(l.home - home, 2) + Math.pow(l.draw - draw, 2) + Math.pow(l.away - away, 2));
            return { ...l, distance };
        });

        matchesWithDistance.sort((a, b) => a.distance - b.distance);
        const similarMatches = matchesWithDistance.slice(0, NUM_MATCHES_TO_ANALYZE);
        
        const outcomes = { homeWin: 0, draw: 0, awayWin: 0 };
        const overUnder15 = { over: 0, under: 0 };
        const overUnder25 = { over: 0, under: 0 };
        let totalGoalsSum = 0;
        const scoreCounts = {};

        similarMatches.forEach(l => {
            outcomes[l.outcome]++;
            const totalGoals = l.homeScore + l.awayScore;
            totalGoalsSum += totalGoals;
            if (totalGoals >= 1.5) overUnder15.over++; else overUnder15.under++;
            if (totalGoals >= 2.5) overUnder25.over++; else overUnder25.under++;
            const score = `${l.homeScore}-${l.awayScore}`;
            scoreCounts[score] = (scoreCounts[score] || 0) + 1;
        });

        const avgTotalGoals = totalGoalsSum / similarMatches.length;
        const prediction = Object.keys(outcomes).reduce((a, b) => outcomes[a] > outcomes[b] ? a : b);
        
        let predictedScore;
        const sortedScores = Object.entries(scoreCounts).sort((a, b) => b[1] - a[1]);
        
        if (sortedScores.length > 0 && sortedScores[0][1] > 2) { // Need at least 3 occurrences to be confident
            predictedScore = sortedScores[0][0];
        } else {
            predictedScore = `${Math.round(similarMatches.reduce((acc, l) => acc + l.homeScore, 0) / similarMatches.length)}-${Math.round(similarMatches.reduce((acc, l) => acc + l.awayScore, 0) / similarMatches.length)}`;
        }
        
        const over15Ratio = overUnder15.over / similarMatches.length;
        const over25Ratio = overUnder25.over / similarMatches.length;
        
        const predictedOverUnder15 = over15Ratio >= 0.5 ? 'over' : 'under';
        const predictedOverUnder25 = over25Ratio >= 0.5 ? 'over' : 'under';

        const predictionStrength = outcomes[prediction] / similarMatches.length;
        const confidence = predictionStrength > 0.65 ? 'Magas' : predictionStrength > 0.50 ? 'Közepes' : 'Alacsony';

        return {
            prediction,
            predictedScore,
            predictedOverUnder15,
            predictedOverUnder25,
            reason: `${similarMatches.length} db legközelebbi oddsú meccs alapján. Kimenetel: H(${outcomes.homeWin})-D(${outcomes.draw})-V(${outcomes.awayWin}). Gólok 2.5: ${overUnder25.over}/${similarMatches.length} (${(over25Ratio*100).toFixed(0)}%) Over.`,
            pattern: 'Odds Elemző',
            avgTotalGoals,
            confidence
        };
    };

    const model_Minta_Elemzo = (homeTeam, awayTeam) => {
        if (logs.length < 5) return { 
            prediction: 'uncertain', 
            predictedScore: '?-?',
            predictedOverUnder15: 'uncertain',
            predictedOverUnder25: 'uncertain',
            reason: 'Nincs elég adat (minimum 5 meccs) a mintaelemzéshez.', 
            pattern: 'Minta Elemző',
            totalGoals: undefined,
            confidence: 'Alacsony'
        };
        
        const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        const getTeamForm = (teamName, location = 'total') => {
            const teamLogs = sortedLogs.filter(l => {
                const teams = l.name.split(' - ').map(t => t.trim().toLowerCase());
                if (location === 'home') return teams[0] === teamName.toLowerCase();
                if (location === 'away') return teams[1] === teamName.toLowerCase();
                return teams.includes(teamName.toLowerCase());
            }).slice(0, 5);
            
            if (teamLogs.length < 3) return { avgGoalsScored: 1.2, avgGoalsConceded: 1.2, strength: 0.5, hasEnoughData: false };

            let goalsScored = 0, goalsConceded = 0, points = 0;
            teamLogs.forEach(l => {
                const teams = l.name.split(' - ').map(t => t.trim().toLowerCase());
                const isHome = teams[0] === teamName.toLowerCase();
                if ((isHome && l.outcome === 'homeWin') || (!isHome && l.outcome === 'awayWin')) points += 3;
                else if (l.outcome === 'draw') points += 1;
                goalsScored += isHome ? l.homeScore : l.awayScore;
                goalsConceded += isHome ? l.awayScore : l.homeScore;
            });
            return {
                avgGoalsScored: goalsScored / teamLogs.length,
                avgGoalsConceded: goalsConceded / teamLogs.length,
                strength: points / (teamLogs.length * 3), // Form strength 0-1
                hasEnoughData: true
            };
        };

        const homeForm = getTeamForm(homeTeam, 'home');
        const awayForm = getTeamForm(awayTeam, 'away');
        
        const expectedHomeGoals = (homeForm.avgGoalsScored + awayForm.avgGoalsConceded) / 2;
        const expectedAwayGoals = (awayForm.avgGoalsScored + homeForm.avgGoalsConceded) / 2;
        const totalGoals = expectedHomeGoals + expectedAwayGoals;

        const homeScore = Math.round(expectedHomeGoals);
        const awayScore = Math.round(expectedAwayGoals);
        
        const prediction = homeScore > awayScore ? 'homeWin' : awayScore > homeScore ? 'awayWin' : 'draw';
        const predictedScore = `${homeScore}-${awayScore}`;

        const predictedOverUnder15 = totalGoals >= 1.5 ? 'over' : 'under';
        const predictedOverUnder25 = totalGoals >= 2.5 ? 'over' : 'under';

        const strengthDiff = Math.abs(homeForm.strength - awayForm.strength);
        let confidence = 'Alacsony';
        if (homeForm.hasEnoughData && awayForm.hasEnoughData) {
            confidence = strengthDiff > 0.3 ? 'Magas' : strengthDiff > 0.15 ? 'Közepes' : 'Alacsony';
        }

        const reason = `Hazai forma (otthon): ${homeForm.strength.toFixed(2)} erősség. Vendég forma (idegenben): ${awayForm.strength.toFixed(2)} erősség. Becsült gólok: H(${expectedHomeGoals.toFixed(2)})-V(${expectedAwayGoals.toFixed(2)}).`;

        return {
            prediction,
            predictedScore,
            predictedOverUnder15,
            predictedOverUnder25,
            reason,
            pattern: 'Minta Elemző',
            totalGoals,
            confidence
        };
    };

    const model_Gol_Modell = (homeTeam, awayTeam, home, draw, away) => {
        const oddsResult = model_Odds_Elemzo(home, draw, away);
        const mintaResult = model_Minta_Elemzo(homeTeam, awayTeam);

        if (oddsResult.avgTotalGoals === undefined || mintaResult.totalGoals === undefined) {
            return {
                predictedOverUnder15: 'uncertain',
                predictedOverUnder25: 'uncertain',
                reason: 'Nincs elég adat a gól modellezéshez (egyik alapmodell nem tudott futni).',
                pattern: 'Gól Modell',
                confidence: 'Alacsony'
            };
        }

        const finalGoalExpectation = (oddsResult.avgTotalGoals * 0.65) + (mintaResult.totalGoals * 0.35);
        const goalDiff = Math.abs(oddsResult.avgTotalGoals - mintaResult.totalGoals);
        const confidence = goalDiff < 0.5 ? 'Magas' : goalDiff < 1.0 ? 'Közepes' : 'Alacsony';
        
        return {
            predictedOverUnder15: finalGoalExpectation >= 1.5 ? 'over' : 'under',
            predictedOverUnder25: finalGoalExpectation >= 2.5 ? 'over' : 'under',
            reason: `Súlyozott gólbecslés. Odds-minta átlaga (${oddsResult.avgTotalGoals.toFixed(2)}) 65%-os, forma-minta (${mintaResult.totalGoals.toFixed(2)}) 35%-os súllyal. Várható gólok: ${finalGoalExpectation.toFixed(2)}.`,
            pattern: 'Gól Modell',
            confidence
        };
    };

    const model_Super_Modell = (homeTeam, awayTeam, home, draw, away) => {
         if (logs.length < 20) return { 
            prediction: 'uncertain', 
            predictedScore: '?-?',
            predictedOverUnder15: 'uncertain',
            predictedOverUnder25: 'uncertain',
            reason: 'Nincs elég adat (minimum 20 meccs) a Szuper Modell futtatásához.', 
            pattern: 'Super Modell',
            confidence: 'Alacsony'
        };

        // 1. Get Base Probabilities (Remove Vigorish)
        const totalProb = (1/home) + (1/draw) + (1/away);
        const trueProbs = { home: (1/home)/totalProb, draw: (1/draw)/totalProb, away: (1/away)/totalProb };

        // 2. Get Statistical Input
        const mintaResult = model_Minta_Elemzo(homeTeam, awayTeam);
        const expectedHomeGoals = (mintaResult.totalGoals * trueProbs.home) / (trueProbs.home + trueProbs.away);
        const expectedAwayGoals = (mintaResult.totalGoals * trueProbs.away) / (trueProbs.home + trueProbs.away);

        // 3. Simulated Learning - Analyze own past mistakes
        const myPastPredictions = predictionsLog.filter(p => p.modelName === 'Super Modell').slice(0, 20);
        let adjustmentFactor = { over25: 1.0, favorite: 1.0 };
        if (myPastPredictions.length > 10) {
            const mistakes = myPastPredictions.filter(p => !p.overUnder25Correct || !p.outcomeCorrect);
            let overBiasCount = 0;
            let favoriteBiasCount = 0;
            mistakes.forEach(m => {
                if (m.predictedOverUnder25 === 'over' && !m.overUnder25Correct) overBiasCount++;
                const odds = JSON.parse(m.oddsData); // Assuming we store odds
                if (m.predictedOutcome !== 'draw' && Math.min(odds.home, odds.away) < 1.6 && !m.outcomeCorrect) favoriteBiasCount++;
            });
            if (overBiasCount > mistakes.length * 0.4) adjustmentFactor.over25 = 0.95; // Be more conservative
            if (favoriteBiasCount > mistakes.length * 0.3) adjustmentFactor.favorite = 0.9; // Be more conservative with strong favorites
        }

        // 4. Monte Carlo Simulation
        const SIMULATIONS = 1000;
        let simOutcomes = { homeWin: 0, draw: 0, awayWin: 0 };
        let simGoals = { over15: 0, over25: 0 };
        let simScores = {};

        for (let i = 0; i < SIMULATIONS; i++) {
            const rand = Math.random();
            let homeLambda = expectedHomeGoals;
            let awayLambda = expectedAwayGoals;
            
            if (home < away) homeLambda *= adjustmentFactor.favorite;
            else awayLambda *= adjustmentFactor.favorite;

            const homeSimGoals = poissonRandom(homeLambda);
            const awaySimGoals = poissonRandom(awayLambda);
            const totalSimGoals = homeSimGoals + awaySimGoals * adjustmentFactor.over25;
            
            const scoreKey = `${homeSimGoals}-${awaySimGoals}`;
            simScores[scoreKey] = (simScores[scoreKey] || 0) + 1;

            if (homeSimGoals > awaySimGoals) simOutcomes.homeWin++;
            else if (awaySimGoals > homeSimGoals) simOutcomes.awayWin++;
            else simOutcomes.draw++;
            
            if (totalSimGoals >= 1.5) simGoals.over15++;
            if (totalSimGoals >= 2.5) simGoals.over25++;
        }
        
        // 5. Aggregate Results
        const prediction = Object.keys(simOutcomes).reduce((a, b) => simOutcomes[a] > simOutcomes[b] ? a : b);
        const predictedScore = Object.keys(simScores).reduce((a, b) => simScores[a] > simScores[b] ? a : b);
        const predictedOverUnder15 = (simGoals.over15 / SIMULATIONS) >= 0.5 ? 'over' : 'under';
        const predictedOverUnder25 = (simGoals.over25 / SIMULATIONS) >= 0.5 ? 'over' : 'under';

        const predictionStrength = simOutcomes[prediction] / SIMULATIONS;
        const confidence = predictionStrength > 0.6 ? 'Magas' : predictionStrength > 0.45 ? 'Közepes' : 'Alacsony';
        const reason = `1000 szimuláció alapján. Valószínűségek: H: ${(simOutcomes.homeWin/SIMULATIONS*100).toFixed(0)}%, D: ${(simOutcomes.draw/SIMULATIONS*100).toFixed(0)}%, V: ${(simOutcomes.awayWin/SIMULATIONS*100).toFixed(0)}%.`;

        return {
            prediction,
            predictedScore,
            predictedOverUnder15,
            predictedOverUnder25,
            reason,
            pattern: 'Super Modell',
            confidence
        };
    };

    function poissonRandom(lambda) {
        if (lambda <= 0 || isNaN(lambda)) return 0;
        let l = Math.exp(-lambda);
        let k = 0;
        let p = 1;
        do {
            k++;
            p *= Math.random();
        } while (p > l);
        return k - 1;
    }
    
    // --- MAIN APP LOGIC ---
    const formatTimestamp = (isoString) => new Date(isoString).toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'short' });

    const renderLogs = () => {
        logListDiv.innerHTML = logs.length === 0 ? `<p class="text-center text-slate-500 py-4">Még nincsenek rögzített eredmények.</p>` : 
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(log => {
                const outcomeClass = log.outcome ? `outcome-${log.outcome}` : 'bg-gray-100 border-gray-300';
                return `<div class="p-3 rounded-lg border shadow-sm transition duration-300 card-hover ${outcomeClass}">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="font-bold text-slate-800 text-base">${log.name || 'Névtelen meccs'}</h3>
                            <div class="font-mono text-sm text-slate-700">H: ${log.home.toFixed(2)}, D: ${log.draw.toFixed(2)}, V: ${log.away.toFixed(2)}</div>
                            <p class="text-sm font-semibold text-slate-600 mt-1">Végeredmény: ${log.homeScore} - ${log.awayScore}</p>
                            <p class="text-xs text-slate-400 mt-1">${formatTimestamp(log.timestamp)}</p>
                        </div>
                        <button data-id="${log.id}" class="delete-log-btn text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
    };

    const saveToLocalStorage = () => {
        localStorage.setItem('tippmixLogs', JSON.stringify(logs));
        localStorage.setItem('tippmixPredictionsLog', JSON.stringify(predictionsLog));
    };

    const loadFromLocalStorage = () => {
        const storedLogs = localStorage.getItem('tippmixLogs');
        const storedPredictions = localStorage.getItem('tippmixPredictionsLog');
        if (storedLogs) logs = JSON.parse(storedLogs);
        if (storedPredictions) predictionsLog = JSON.parse(storedPredictions);
        renderLogs();
    };

    const runAIAnalysis = (activePanel) => {
        if (!activePanel) return;
        const homeTeamInput = activePanel.querySelector('.ai-home-team');
        const awayTeamInput = activePanel.querySelector('.ai-away-team');
        const aiHomeInput = activePanel.querySelector('.ai-home');
        const aiDrawInput = activePanel.querySelector('.ai-draw');
        const aiAwayInput = activePanel.querySelector('.ai-away');
        const aiResultDiv = activePanel.querySelector('.ai-result');

        const home = parseFloat(aiHomeInput.value.replace(',', '.'));
        const draw = parseFloat(aiDrawInput.value.replace(',', '.'));
        const away = parseFloat(aiAwayInput.value.replace(',', '.'));
        const homeTeam = homeTeamInput.value.trim();
        const awayTeam = awayTeamInput.value.trim();

        if (isNaN(home) || isNaN(draw) || isNaN(away) || !homeTeam || !awayTeam) {
            aiResultDiv.innerHTML = '<span class="text-gray-400">Add meg a csapatneveket és az oddsokat!</span>'; return;
        }
        
        aiResultDiv.innerHTML = `<div class="p-4 space-y-3"><div class="flex items-center justify-center space-x-2 mt-2"><div class="loader"></div><span class="text-sm text-gray-400">Elemzés...</span></div></div>`;

        setTimeout(() => {
            const oddsResult = model_Odds_Elemzo(home, draw, away);
            const mintaResult = model_Minta_Elemzo(homeTeam, awayTeam);
            const golResult = model_Gol_Modell(homeTeam, awayTeam, home, draw, away);
            const superResult = model_Super_Modell(homeTeam, awayTeam, home, draw, away);
            
            const outcomeMap = { homeWin: 'Hazai (1)', draw: 'Döntetlen (X)', awayWin: 'Vendég (2)', uncertain: 'Bizonytalan' };
            const overUnderMap = { over: 'Felett', under: 'Alatt', uncertain: '?' };
            const confidenceColors = { 'Magas': 'bg-green-600', 'Közepes': 'bg-yellow-500', 'Alacsony': 'bg-red-600', undefined: 'bg-gray-500' };

            const createCardHTML = (title, result) => {
                const hasOutcome = result.prediction && result.predictedScore;
                return `<div class="p-3 bg-gray-700 rounded-lg text-left">
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold text-teal-400">${title}</h4>
                        <span class="text-xs font-bold text-white px-2 py-0.5 rounded-full ${confidenceColors[result.confidence]}">${result.confidence || ''}</span>
                    </div>
                    ${hasOutcome ? `<p class="text-sm text-teal-300 mt-1">${outcomeMap[result.prediction] || 'Ismeretlen'} (${result.predictedScore})</p>` : `<p class="text-xs text-gray-400 mt-1">Ez a modell csak gólokat becsül.</p>`}
                    <div class="grid grid-cols-2 gap-2 text-center mt-2">
                        <div class="bg-gray-800 p-2 rounded-md">
                            <p class="text-xs text-gray-400">Gólok 1.5</p>
                            <p class="font-bold text-white">${overUnderMap[result.predictedOverUnder15]}</p>
                        </div>
                        <div class="bg-gray-800 p-2 rounded-md">
                            <p class="text-xs text-gray-400">Gólok 2.5</p>
                            <p class="font-bold text-white">${overUnderMap[result.predictedOverUnder25]}</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-300 whitespace-pre-wrap mt-2">${result.reason}</p>
                </div>`;
            };
            
            const saveResultHTML = `
                <div class="p-3 bg-gray-600 rounded-lg text-left">
                    <h4 class="font-bold text-gray-300 text-sm uppercase tracking-wider mb-2">Eredmény rögzítése</h4>
                    <div class="flex items-center space-x-2">
                        <input type="number" placeholder="H" class="actual-home-score w-16 px-2 py-1 text-sm rounded-lg bg-gray-800 border border-gray-500 focus:ring-2 focus:ring-teal-400 text-white text-center">
                        <span class="text-gray-400">-</span>
                        <input type="number" placeholder="V" class="actual-away-score w-16 px-2 py-1 text-sm rounded-lg bg-gray-800 border border-gray-500 focus:ring-2 focus:ring-teal-400 text-white text-center">
                        <button class="save-result-btn ml-auto bg-purple-600 text-white font-semibold py-1 px-3 rounded-lg text-sm btn-hover hover:bg-purple-700">Mentés</button>
                    </div>
                    <div class="result-feedback text-center text-sm mt-2"></div>
                </div>`;

            aiResultDiv.innerHTML = `<div class="space-y-3">
                ${createCardHTML('Super Modell (Ajánlott)', superResult)}
                ${createCardHTML('Odds Elemző', oddsResult)}
                ${createCardHTML('Minta Elemző', mintaResult)}
                ${createCardHTML('Gól Modell', golResult)}
                ${saveResultHTML}
            </div>`;

            const saveBtn = activePanel.querySelector('.save-result-btn');
            const oddsData = JSON.stringify({home, draw, away});
            Object.assign(saveBtn.dataset, {
                homeTeam, awayTeam, oddsData,
                oddsPrediction: oddsResult.prediction, oddsPredictedScore: oddsResult.predictedScore, oddsPattern: oddsResult.pattern,
                oddsPredictedOverUnder15: oddsResult.predictedOverUnder15, oddsPredictedOverUnder25: oddsResult.predictedOverUnder25,
                mintaPrediction: mintaResult.prediction, mintaPredictedScore: mintaResult.predictedScore, mintaPattern: mintaResult.pattern,
                mintaPredictedOverUnder15: mintaResult.predictedOverUnder15, mintaPredictedOverUnder25: mintaResult.predictedOverUnder25,
                golPrediction: 'n/a', golPredictedScore: 'n/a', golPattern: golResult.pattern,
                golPredictedOverUnder15: golResult.predictedOverUnder15, golPredictedOverUnder25: golResult.predictedOverUnder25,
                superPrediction: superResult.prediction, superPredictedScore: superResult.predictedScore, superPattern: superResult.pattern,
                superPredictedOverUnder15: superResult.predictedOverUnder15, superPredictedOverUnder25: superResult.predictedOverUnder25
            });
        }, 250);
    };
    
    // --- UI HELPER FUNCTIONS ---
    const addAITab = () => {
        const tabId = Date.now().toString();
        const tabCount = aiTabsContainer.children.length + 1;
        const tab = document.createElement('button');
        tab.className = 'tab px-4 py-2 text-sm font-medium border border-gray-600 rounded-t-lg -mb-px text-gray-300 shrink-0';
        tab.dataset.id = tabId;
        tab.innerHTML = `Tipp ${tabCount} <span class="close-tab ml-2 text-red-500 opacity-50 hover:opacity-100">&times;</span>`;
        const panel = document.createElement('div');
        panel.className = 'ai-tab-panel p-1';
        panel.dataset.id = tabId;
        panel.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                <input type="text" placeholder="Hazai csapat" class="ai-input ai-home-team w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" placeholder="Vendég csapat" class="ai-input ai-away-team w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <input type="text" inputmode="decimal" placeholder="Hazai (1)" class="ai-input ai-home w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" inputmode="decimal" placeholder="Döntetlen (X)" class="ai-input ai-draw w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" inputmode="decimal" placeholder="Vendég (2)" class="ai-input ai-away w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
            </div>
            <div class="ai-result text-center font-medium pt-2 space-y-1 text-sm flex flex-col justify-center min-h-[550px]"></div>`;
        aiTabsContainer.appendChild(tab);
        aiPanelsContainer.appendChild(panel);
        switchAITab(tabId);
    };
    const switchAITab = (tabId) => {
        activeAITabId = tabId;
        aiTabsContainer.querySelectorAll('.tab').forEach(t => {
            const isActive = t.dataset.id === tabId;
            t.classList.toggle('active', isActive);
            t.style.backgroundColor = isActive ? '#1f2937' : ''; t.style.borderColor = isActive ? '#4b5563' : '#4b5563'; t.style.borderBottomColor = isActive ? '#1f2937' : '#4b5563';
        });
        aiPanelsContainer.querySelectorAll('.ai-tab-panel').forEach(p => p.classList.toggle('active', p.dataset.id === tabId));
    };
    const closeAITab = (tabId) => {
        const tab = aiTabsContainer.querySelector(`[data-id="${tabId}"]`);
        const panel = aiPanelsContainer.querySelector(`[data-id="${tabId}"]`);
        if (tab) tab.remove();
        if (panel) panel.remove();
        if (activeAITabId === tabId) {
            const firstTab = aiTabsContainer.querySelector('.tab');
            if (firstTab) switchAITab(firstTab.dataset.id); else addAITab();
        }
        aiTabsContainer.querySelectorAll('.tab').forEach((t, index) => {
            const closeSpan = t.querySelector('.close-tab');
            t.innerHTML = `Tipp ${index + 1} `; t.appendChild(closeSpan);
        });
    };
    const deleteLog = (id) => { 
        logs = logs.filter(l => l.id !== parseFloat(id)); 
        saveToLocalStorage(); 
        renderLogs(); 
    };
    
    const resetStatistics = () => {
        if (resetStatsBtn.dataset.confirming !== 'true') {
            resetStatsBtn.dataset.confirming = 'true';
            resetStatsBtn.querySelector('span').textContent = 'Biztos vagy benne?';
            setTimeout(() => {
                resetStatsBtn.dataset.confirming = 'false';
                resetStatsBtn.querySelector('span').textContent = 'Statisztika Törlése';
            }, 3000);
        } else {
            predictionsLog = [];
            saveToLocalStorage();
            renderStatistics();
            resetStatsBtn.dataset.confirming = 'false';
            resetStatsBtn.querySelector('span').textContent = 'Statisztika Törlése';
        }
    };

    const renderStatistics = () => {
        const modelsToTrack = ['Super Modell', 'Odds Elemző', 'Minta Elemző', 'Gól Modell'];
        const stats = {};
        modelsToTrack.forEach(name => {
            stats[name] = { total: 0, outcomeCorrect: 0, overUnder15Correct: 0, overUnder25Correct: 0, teams: {} };
        });

        predictionsLog.forEach(p => {
            const modelStat = stats[p.modelName];
            if (!modelStat) return;
            modelStat.total++;
            if (p.outcomeCorrect) modelStat.outcomeCorrect++;
            if (p.overUnder15Correct) modelStat.overUnder15Correct++;
            if (p.overUnder25Correct) modelStat.overUnder25Correct++;
            
            if(p.modelName !== 'Gól Modell') {
                const teams = p.teams.split(' - ');
                teams.forEach(team => {
                    const teamName = team.trim();
                    if (!teamName) return;
                    if (!modelStat.teams[teamName]) modelStat.teams[teamName] = { total: 0, correct: 0 };
                    modelStat.teams[teamName].total++;
                    if (p.outcomeCorrect) modelStat.teams[teamName].correct++;
                });
            }
        });

        const createTableHTML = (title, data) => {
            const sortedData = Object.entries(data).sort(([, a], [, b]) => b.total - a.total).slice(0, 15);
            if(sortedData.length === 0) return '';
            return `<div class="mt-4"><h4 class="font-semibold text-slate-600 mb-2">${title}</h4><div class="overflow-hidden border border-gray-200 rounded-lg"><table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left font-medium text-gray-500">Név</th><th class="px-4 py-2 text-right font-medium text-gray-500">Találat / Összes</th><th class="px-4 py-2 text-right font-medium text-gray-500">Siker (%)</th></tr></thead><tbody class="divide-y divide-gray-200 bg-white">${sortedData.map(([name, {total, correct}]) => `<tr><td class="px-4 py-2 font-medium text-gray-900">${name}</td><td class="px-4 py-2 text-right text-gray-700">${correct} / ${total}</td><td class="px-4 py-2 text-right text-gray-700 font-semibold">${((correct/total)*100).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div></div>`;
        };

        let finalHTML = '';
        for (const modelName in stats) {
            const modelStat = stats[modelName];
            if (modelStat.total === 0) continue;
            const outcomeSuccessRate = ((modelStat.outcomeCorrect / modelStat.total) * 100).toFixed(1);
            const ou15SuccessRate = ((modelStat.overUnder15Correct / modelStat.total) * 100).toFixed(1);
            const ou25SuccessRate = ((modelStat.overUnder25Correct / modelStat.total) * 100).toFixed(1);

            const isGoalModel = modelName === 'Gól Modell';
            
            finalHTML += `<div class="bg-slate-50 p-4 rounded-lg border">
                <h3 class="text-lg font-bold text-slate-800">${modelName}</h3>
                <div class="grid grid-cols-1 ${isGoalModel ? 'md:grid-cols-2' : 'md:grid-cols-3'} gap-4 mt-2 text-center">
                    ${!isGoalModel ? `<div>
                        <p class="text-sm text-slate-500">Kimenetel</p>
                        <p class="text-2xl font-bold text-blue-600">${outcomeSuccessRate}%</p>
                        <p class="text-sm text-slate-500">(${modelStat.outcomeCorrect} / ${modelStat.total})</p>
                    </div>` : ''}
                    <div>
                        <p class="text-sm text-slate-500">Gólok 1.5 +/-</p>
                        <p class="text-2xl font-bold text-green-600">${ou15SuccessRate}%</p>
                        <p class="text-sm text-slate-500">(${modelStat.overUnder15Correct} / ${modelStat.total})</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-500">Gólok 2.5 +/-</p>
                        <p class="text-2xl font-bold text-purple-600">${ou25SuccessRate}%</p>
                        <p class="text-sm text-slate-500">(${modelStat.overUnder25Correct} / ${modelStat.total})</p>
                    </div>
                </div>
                ${!isGoalModel ? createTableHTML('Kimenetel teljesítmény csapatok szerint', modelStat.teams) : ''}
            </div>`;
        }
        statsContent.innerHTML = finalHTML || `<p class="text-center text-slate-500 py-8">Nincsenek rögzített AI tippek a statisztikához.</p>`;
    };
    
    // --- INITIALIZATION AND EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        loadFromLocalStorage();
        if (aiTabsContainer.children.length === 0) addAITab();
    });

    aiPanelsContainer.addEventListener('input', e => {
        if (e.target.classList.contains('ai-input')) {
            clearTimeout(analysisTimeout);
            const activePanel = e.target.closest('.ai-tab-panel');
            analysisTimeout = setTimeout(() => runAIAnalysis(activePanel), 500);
        }
    });

    aiPanelsContainer.addEventListener('click', e => {
        const btn = e.target.closest('.save-result-btn');
        if (btn && !btn.disabled) {
            const panel = btn.closest('.ai-tab-panel');
            const actualHomeScore = parseInt(panel.querySelector('.actual-home-score').value, 10);
            const actualAwayScore = parseInt(panel.querySelector('.actual-away-score').value, 10);
            const feedbackDiv = panel.querySelector('.result-feedback');
            if (isNaN(actualHomeScore) || isNaN(actualAwayScore)) { 
                feedbackDiv.innerHTML = `<span class="font-bold text-red-500">Kérlek add meg a valós végeredményt!</span>`;
                setTimeout(() => feedbackDiv.innerHTML = '', 3000);
                return;
            }

            const actualOutcome = (actualHomeScore > actualAwayScore) ? 'homeWin' : (actualAwayScore > actualHomeScore) ? 'awayWin' : 'draw';
            const actualTotalGoals = actualHomeScore + actualAwayScore;
            const newLog = { id: Date.now(), name: `${btn.dataset.homeTeam} - ${btn.dataset.awayTeam}`, home: parseFloat(JSON.parse(btn.dataset.oddsData).home), draw: parseFloat(JSON.parse(btn.dataset.oddsData).draw), away: parseFloat(JSON.parse(btn.dataset.oddsData).away), homeScore: actualHomeScore, awayScore: actualAwayScore, outcome: actualOutcome, timestamp: new Date().toISOString() };
            logs.unshift(newLog);
            renderLogs();
            
            ['odds', 'minta', 'gol', 'super'].forEach(prefix => {
                const modelNameMap = { odds: 'Odds Elemző', minta: 'Minta Elemző', gol: 'Gól Modell', super: 'Super Modell' };
                const predOU15 = btn.dataset[`${prefix}PredictedOverUnder15`];
                const predOU25 = btn.dataset[`${prefix}PredictedOverUnder25`];

                 // Ensure prediction data exists before pushing
                if (!predOU15) return;

                predictionsLog.unshift({
                    id: Date.now() + Math.random(),
                    modelName: modelNameMap[prefix],
                    teams: `${btn.dataset.homeTeam} - ${btn.dataset.awayTeam}`,
                    pattern: btn.dataset[`${prefix}Pattern`],
                    predictedOutcome: btn.dataset[`${prefix}Prediction`],
                    predictedScore: btn.dataset[`${prefix}PredictedScore`],
                    actualScore: `${actualHomeScore}-${actualAwayScore}`,
                    outcomeCorrect: btn.dataset[`${prefix}Prediction`] === actualOutcome,
                    predictedOverUnder15: predOU15,
                    predictedOverUnder25: predOU25,
                    overUnder15Correct: (predOU15 === 'over' && actualTotalGoals >= 1.5) || (predOU15 === 'under' && actualTotalGoals < 1.5),
                    overUnder25Correct: (predOU25 === 'over' && actualTotalGoals >= 2.5) || (predOU25 === 'under' && actualTotalGoals < 2.5),
                    oddsData: btn.dataset.oddsData,
                });
            });
            
            saveToLocalStorage();
            feedbackDiv.innerHTML = `<span class="font-bold text-green-500">Eredmény sikeresen rögzítve!</span>`;
            btn.disabled = true;
            panel.querySelectorAll('input').forEach(i => i.disabled = true);
        }
    });
    
    addAITabBtn.addEventListener('click', addAITab);
    
    aiTabsContainer.addEventListener('click', e => {
        const tab = e.target.closest('.tab');
        if (tab && !e.target.classList.contains('close-tab')) switchAITab(tab.dataset.id);
        const closeBtn = e.target.closest('.close-tab');
        if (closeBtn) closeAITab(closeBtn.parentElement.dataset.id);
    });

    logListDiv.addEventListener('click', e => {
        const btn = e.target.closest('.delete-log-btn');
        if (btn) deleteLog(btn.dataset.id);
    });
    
    openStatsBtn.addEventListener('click', () => { renderStatistics(); statsModal.classList.remove('hidden'); });
    closeStatsBtn.addEventListener('click', () => { statsModal.classList.add('hidden'); });
    statsModal.addEventListener('click', (e) => { if (e.target === statsModal) { statsModal.classList.add('hidden'); } });
    resetStatsBtn.addEventListener('click', resetStatistics);
    
    const downloadFile = (data, filename, type) => {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    };

    exportJsonBtn.addEventListener('click', () => {
        const dataStr = JSON.stringify({ logs, predictionsLog }, null, 2);
        downloadFile(dataStr, 'vsport_data.json', 'application/json');
        importStatus.textContent = 'JSON adatok exportálva!';
        setTimeout(() => importStatus.textContent = '', 3000);
    });

    exportCsvBtn.addEventListener('click', () => {
        const convertToCSV = (arr, headers) => {
            const replacer = (key, value) => value === null ? '' : value;
            const headerRow = headers.join(',');
            const dataRows = arr.map(row => headers.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(',')).join('\r\n');
            return [headerRow, dataRows].join('\r\n');
        };

        if (logs.length > 0) {
            const headers = ['id', 'name', 'home', 'draw', 'away', 'homeScore', 'awayScore', 'outcome', 'timestamp'];
            downloadFile(convertToCSV(logs, headers), 'vsport_meccsek.csv', 'text/csv;charset=utf-8;');
        }
        if (predictionsLog.length > 0) {
            const headers = ['id', 'modelName', 'teams', 'pattern', 'predictedOutcome', 'predictedScore', 'actualScore', 'outcomeCorrect', 'predictedOverUnder15', 'predictedOverUnder25', 'overUnder15Correct', 'overUnder25Correct'];
            downloadFile(convertToCSV(predictionsLog, headers), 'vsport_tippek.csv', 'text/csv;charset=utf-8;');
        }
        importStatus.textContent = 'CSV adatok exportálva!';
        setTimeout(() => importStatus.textContent = '', 3000);
    });

    importDataBtn.addEventListener('click', () => importFileInput.click());

    importFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data.logs) && Array.isArray(data.predictionsLog)) {
                    logs = data.logs;
                    predictionsLog = data.predictionsLog;
                    saveToLocalStorage();
                    renderLogs();
                    importStatus.textContent = 'Adatok sikeresen importálva!';
                } else { throw new Error('Hibás fájlformátum.'); }
            } catch (error) {
                importStatus.textContent = `Hiba: ${error.message}`;
            } finally {
                importFileInput.value = '';
                setTimeout(() => importStatus.textContent = '', 3000);
            }
        };
        reader.readAsText(file);
    });

</script>

</body>
</html>

