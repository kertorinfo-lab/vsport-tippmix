<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSPORT Elemző</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .loader { width: 32px; height: 32px; border: 4px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">

    <div id="login-page" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg border border-gray-200">
            <h1 class="text-3xl font-bold text-center text-slate-900">Bejelentkezés</h1>
            <p class="text-center text-slate-500 mt-2 mb-6">Jelentkezz be a fiókodba a folytatáshoz.</p>
            <form id="login-form" class="space-y-4">
                <input name="name" type="text" placeholder="Név" required class="w-full px-4 py-2 text-base rounded-lg bg-slate-100 border border-gray-300 focus:ring-2 focus:ring-purple-400">
                <input name="email" type="email" value="mohacsikrisz75@gmail.com" placeholder="Email cím" required class="w-full px-4 py-2 text-base rounded-lg bg-slate-100 border border-gray-300 focus:ring-2 focus:ring-purple-400">
                <input name="password" type="password" value="fonix" placeholder="Jelszó" required class="w-full px-4 py-2 text-base rounded-lg bg-slate-100 border border-gray-300 focus:ring-2 focus:ring-purple-400">
                <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 hover:bg-purple-700 hover:translateY(-2px)">Belépés</button>
            </form>
        </div>
    </div>

    <div id="waiting-room-page" class="hidden flex-col items-center justify-center min-h-screen text-center p-4">
        <div class="w-full max-w-lg bg-white p-8 rounded-2xl shadow-lg border border-gray-200">
            <svg class="mx-auto h-16 w-16 text-purple-500" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h1 class="text-3xl font-bold text-slate-900 mt-4">Váróterem</h1>
            <p class="text-slate-500 mt-2">Várakozás az adminisztrátor engedélyére a belépéshez...<br>Az oldal automatikusan frissülni fog.</p>
        </div>
    </div>

    <main id="app-page" class="hidden w-full max-w-xl bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mx-auto my-8">
        <div class="flex justify-between items-center">
            <div>
                 <h1 class="text-2xl font-bold text-slate-900">AI Elemző</h1>
                 <p id="app-welcome-user" class="text-slate-500 mt-1"></p>
            </div>
            <button id="logout-btn" class="bg-red-500 text-white text-sm font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 hover:bg-red-600">Kijelentkezés</button>
        </div>
       
        <div class="bg-gray-800 text-white p-5 rounded-xl border border-gray-700 space-y-4 mt-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                <input type="text" placeholder="Hazai csapat" class="ai-input ai-home-team w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" placeholder="Vendég csapat" class="ai-input ai-away-team w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <input type="text" inputmode="decimal" placeholder="Hazai (1)" class="ai-input ai-home w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" inputmode="decimal" placeholder="Döntetlen (X)" class="ai-input ai-draw w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" inputmode="decimal" placeholder="Vendég (2)" class="ai-input ai-away w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
            </div>
             <div class="flex justify-start items-center mt-2 text-sm text-gray-300">
                <label for="vsport-mode" class="flex items-center cursor-pointer">
                    <input type="checkbox" id="vsport-mode" class="vsport-mode mr-2 h-4 w-4 rounded bg-gray-600 border-gray-500 text-teal-500 focus:ring-teal-500">
                    VSport mód
                </label>
            </div>
            <div class="ai-result text-center font-medium pt-2 space-y-1 text-sm flex flex-col justify-center min-h-[250px]">
                <span class="text-gray-400">Add meg a csapatneveket és az oddsokat az elemzéshez!</span>
            </div>
        </div>
    </main>

<script>
// --- PAGE ELEMENTS ---
const loginPage = document.getElementById('login-page');
const waitingRoomPage = document.getElementById('waiting-room-page');
const appPage = document.getElementById('app-page');
const loginForm = document.getElementById('login-form');
const logoutBtn = document.getElementById('logout-btn');
const appWelcomeUser = document.getElementById('app-welcome-user');
const aiResultDiv = document.querySelector('.ai-result');

// --- APP STATE ---
let logs = []; // Ezt az adatbázist használják a modellek
let analysisTimeout;
let waitingRoomInterval;

// --- AI MODEL "MODULE" (Másolva az admin oldalról) ---
const AI_MODELS = {
    model_Odds_Elemzo(home, draw, away, isVSport = false) {
        const MIN_LOGS_TOTAL = 10;
        
        if (logs.length < MIN_LOGS_TOTAL) {
            return {
                prediction: 'uncertain', predictedScore: '?-?', predictedOverUnder15: 'uncertain',
                predictedOverUnder25: 'uncertain', predictedOverUnder35: 'uncertain',
                reason: `Nincs elég adat (minimum ${MIN_LOGS_TOTAL} meccs) az elemzéshez.`,
                pattern: 'Odds Elemző', confidence: 'Alacsony', predictionStrength: 0
            };
        }
        
        const getCluster = (h, d, a) => {
            const h_c = h < 1.8 ? 'fav' : h < 2.5 ? 'mid' : 'dog';
            const d_c = d < 3.3 ? 'low' : d < 4.0 ? 'mid' : 'high';
            return `${h_c}-${d_c}`;
        };
        const currentCluster = getCluster(home, draw, away);
        let similarMatches = logs.filter(l => getCluster(l.home, l.draw, l.away) === currentCluster);

        if (similarMatches.length < 5) {
            return {
                prediction: 'uncertain', predictedScore: '?-?', predictedOverUnder15: 'uncertain',
                predictedOverUnder25: 'uncertain', predictedOverUnder35: 'uncertain',
                reason: `Nincs elég adat ebben az odds-klaszterben (${currentCluster}). Csak ${similarMatches.length} meccs található.`,
                pattern: 'Odds Elemző', confidence: 'Alacsony', predictionStrength: 0
            };
        }

        const outcomes = { homeWin: 0, draw: 0, awayWin: 0 };
        const overUnder = { '15': { over: 0 }, '25': { over: 0 }, '35': { over: 0 } };
        const scoreCounts = {};
        let reason = `${similarMatches.length} meccs a(z) "${currentCluster}" klaszterből.`;

        similarMatches.forEach(l => {
            outcomes[l.outcome]++;
            const totalGoals = l.homeScore + l.awayScore;
            if (totalGoals >= 1.5) overUnder['15'].over++;
            if (totalGoals >= 2.5) overUnder['25'].over++;
            if (totalGoals >= 3.5) overUnder['35'].over++;
            const score = `${l.homeScore}-${l.awayScore}`;
            scoreCounts[score] = (scoreCounts[score] || 0) + 1;
        });
        
        let prediction = Object.keys(outcomes).reduce((a, b) => outcomes[a] > outcomes[b] ? a : b);
        
        if (isVSport) {
            const favWinRate = currentCluster.startsWith('fav') ? outcomes.homeWin / similarMatches.length : 1 - (outcomes.awayWin / similarMatches.length);
            const biasFactor = 1 + (favWinRate - 0.5) * 0.2;
            outcomes.homeWin *= biasFactor;
            if (draw > 3.5) outcomes.draw *= 0.5;
            prediction = Object.keys(outcomes).reduce((a, b) => outcomes[a] > outcomes[b] ? a : b);
            reason += ` [VSport bias: Dinamikus favorit súlyozás (${biasFactor.toFixed(2)}x).]`;
        }

        let predictedScore;
        const sortedScores = Object.entries(scoreCounts).sort((a, b) => b[1] - a[1]);
        if (sortedScores.length > 0 && sortedScores[0][1] / similarMatches.length > 0.15) {
            predictedScore = sortedScores[0][0];
        } else {
            predictedScore = `${Math.round(similarMatches.reduce((acc, l) => acc + l.homeScore, 0) / similarMatches.length)}-${Math.round(similarMatches.reduce((acc, l) => acc + l.awayScore, 0) / similarMatches.length)}`;
        }
        
        const predictionStrength = outcomes[prediction] / (outcomes.homeWin + outcomes.draw + outcomes.awayWin);
        const confidence = predictionStrength > 0.65 ? 'Magas' : predictionStrength > 0.50 ? 'Közepes' : 'Alacsony';
        
        return {
            prediction, predictedScore,
            predictedOverUnder15: (overUnder['15'].over / similarMatches.length) >= 0.5 ? 'over' : 'under',
            predictedOverUnder25: (overUnder['25'].over / similarMatches.length) >= 0.5 ? 'over' : 'under',
            predictedOverUnder35: (overUnder['35'].over / similarMatches.length) >= 0.5 ? 'over' : 'under',
            reason, pattern: 'Odds Elemző', confidence, predictionStrength
        };
    },

    model_Minta_Elemzo(homeTeam, awayTeam, isVSport = false) {
         if (!isVSport) {
            const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const homeLogs = sortedLogs.filter(l => l.name.toLowerCase().includes(homeTeam.toLowerCase())).slice(0,5);
            const awayLogs = sortedLogs.filter(l => l.name.toLowerCase().includes(awayTeam.toLowerCase())).slice(0,5);
            if (homeLogs.length < 3 || awayLogs.length < 3) return { prediction: 'uncertain', predictedScore: '?-?', reason: 'Nincs elég adat a csapat formájához.', pattern: 'Minta Elemző', confidence: 'Alacsony'};
            const homeGoalAvg = homeLogs.reduce((a, b) => a + b.homeScore, 0) / homeLogs.length;
            const awayGoalAvg = awayLogs.reduce((a, b) => a + b.awayScore, 0) / awayLogs.length;
            const totalGoals = homeGoalAvg + awayGoalAvg;
            return {
                prediction: homeGoalAvg > awayGoalAvg ? 'homeWin' : awayGoalAvg > homeGoalAvg ? 'awayWin' : 'draw',
                predictedScore: `${Math.round(homeGoalAvg)}-${Math.round(awayGoalAvg)}`,
                predictedOverUnder15: totalGoals >= 1.5 ? 'over' : 'under',
                predictedOverUnder25: totalGoals >= 2.5 ? 'over' : 'under',
                predictedOverUnder35: totalGoals >= 3.5 ? 'over' : 'under',
                reason: `Alap csapat-forma elemzés.`, pattern: 'Minta Elemző', confidence: 'Közepes'
            };
         }

         const lastLogs = logs.slice(0, 15);
         if (lastLogs.length < 10) {
             return {
                 prediction: 'uncertain', predictedScore: '?-?', predictedOverUnder15: 'uncertain',
                 predictedOverUnder25: 'uncertain', predictedOverUnder35: 'uncertain',
                 reason: 'Nincs elég adat (minimum 10 meccs) a globális sorozat elemzéséhez.',
                 pattern: 'Minta Elemző', confidence: 'Alacsony', streakLength: 0
             };
         }

         const weights = [1.5, 1.2, 1.1, 1.0, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4];
         let streakCounts = { draw: 0, over25: 0, favWin: 0, totalWeight: 0, favCount: 0 };
         let currentStreaks = { draw: 0, under: 0, over: 0 };

         lastLogs.slice(0,10).forEach((l, index) => {
             const weight = weights[index] || 0.4;
             if (l.outcome === 'draw') streakCounts.draw += weight;
             if ((l.homeScore + l.awayScore) >= 2.5) streakCounts.over25 += weight;
             if (l.home < 1.8 || l.away < 1.8) {
                 streakCounts.favCount += weight;
                 if ((l.home < 1.8 && l.outcome === 'homeWin') || (l.away < 1.8 && l.outcome === 'awayWin')) {
                     streakCounts.favWin += weight;
                 }
             }
             streakCounts.totalWeight += weight;
         });

        for(let i=0; i < lastLogs.length; i++) {
            if(lastLogs[i].outcome === 'draw') currentStreaks.draw++; else break;
        }
         
         const drawProbability = streakCounts.draw / streakCounts.totalWeight;
         const over25Probability = streakCounts.over25 / streakCounts.totalWeight;
         const favWinProbability = streakCounts.favCount > 0 ? streakCounts.favWin / streakCounts.favCount : 0.5;

         let prediction = 'uncertain';
         if (drawProbability > 0.5) prediction = 'draw';
         else if (favWinProbability > 0.65) prediction = 'homeWin';
         else if (favWinProbability < 0.35) prediction = 'awayWin';
         
         const streakLength = Math.max(currentStreaks.draw);

         return {
             prediction, predictedScore: '?-?', 
             predictedOverUnder15: over25Probability > 0.2 ? 'over' : 'under',
             predictedOverUnder25: over25Probability > 0.5 ? 'over' : 'under',
             predictedOverUnder35: over25Probability > 0.7 ? 'over' : 'under',
             reason: `Globális sorozat elemzés. Döntetlen arány: ${(drawProbability*100).toFixed(0)}%. Favorit győzelmi arány: ${(favWinProbability*100).toFixed(0)}%.`, 
             pattern: 'Minta Elemző', confidence: 'Közepes', streakLength
         };
    }
};

// --- CORE APP LOGIC ---
const loadFromLocalStorage = () => {
    const storedLogs = localStorage.getItem('tippmixLogs');
    if (storedLogs) logs = JSON.parse(storedLogs);
};

const synthesizeResults = (oddsResult, mintaResult) => {
    const confidenceScore = { 'Magas': 3, 'Közepes': 2, 'Alacsony': 1, 'Bizonytalan': 0, undefined: 0 };
    const oddsScore = confidenceScore[oddsResult.confidence] || 0;
    const mintaScore = confidenceScore[mintaResult.confidence] || 0;

    if (oddsResult.prediction === 'uncertain' && mintaResult.prediction === 'uncertain') {
        return { prediction: 'Bizonytalan', reason: 'Egyik modell sem tudott egyértelmű tippet adni a rendelkezésre álló adatok alapján.' };
    }
    
    if (oddsResult.prediction === mintaResult.prediction && oddsResult.prediction !== 'uncertain') {
         return { prediction: oddsResult.prediction, reason: `Mindkét modell (${oddsResult.pattern}, ${mintaResult.pattern}) egyetért a kimenetelben. Az Odds Elemző ${oddsResult.confidence} magabiztossággal javasolja ezt.` };
    }
    
    if (oddsScore > mintaScore + 1) {
        return { prediction: oddsResult.prediction, reason: `Az "${oddsResult.pattern}" modell (${oddsResult.confidence}) sokkal magabiztosabb, mint a másik modell. Javaslata: ${outcomeMap[oddsResult.prediction]}.` };
    }
     if (mintaScore > oddsScore + 1) {
        return { prediction: mintaResult.prediction, reason: `A "${mintaResult.pattern}" modell (${mintaResult.confidence}) sokkal magabiztosabb, mint a másik modell. Javaslata: ${outcomeMap[mintaResult.prediction]}.` };
    }

    if (oddsResult.prediction !== 'uncertain') {
        return { prediction: oddsResult.prediction, reason: `A modellek nem értenek egyet. A több adaton alapuló "${oddsResult.pattern}" (${oddsResult.confidence}) javaslatát részesítjük előnyben.` };
    }

    if (mintaResult.prediction !== 'uncertain') {
        return { prediction: mintaResult.prediction, reason: `Az Odds Elemző bizonytalan volt, így a "${mintaResult.pattern}" (${mintaResult.confidence}) javaslatát mutatjuk.` };
    }

    return { prediction: 'Bizonytalan', reason: 'A modellek ellentmondásos vagy bizonytalan eredményt adtak.' };
};

const runAIAnalysis = () => {
    const homeTeam = document.querySelector('.ai-home-team').value.trim();
    const awayTeam = document.querySelector('.ai-away-team').value.trim();
    const home = parseFloat(document.querySelector('.ai-home').value.replace(',', '.'));
    const draw = parseFloat(document.querySelector('.ai-draw').value.replace(',', '.'));
    const away = parseFloat(document.querySelector('.ai-away').value.replace(',', '.'));
    const isVSport = document.querySelector('.vsport-mode').checked;

    if (isNaN(home) || isNaN(draw) || isNaN(away) || !homeTeam || !awayTeam) {
        aiResultDiv.innerHTML = '<span class="text-gray-400">Add meg a csapatneveket és az oddsokat!</span>';
        return;
    }
    
    aiResultDiv.innerHTML = `<div class="flex items-center justify-center space-x-2 mt-2"><div class="loader"></div><span class="text-sm text-gray-400">Elemzés...</span></div>`;

    setTimeout(() => {
        loadFromLocalStorage();
        const oddsResult = AI_MODELS.model_Odds_Elemzo(home, draw, away, isVSport);
        const mintaResult = AI_MODELS.model_Minta_Elemzo(homeTeam, awayTeam, isVSport);
        const finalTip = synthesizeResults(oddsResult, mintaResult);
        const outcomeMap = { homeWin: 'Hazai győzelem (1)', draw: 'Döntetlen (X)', awayWin: 'Vendég győzelem (2)', uncertain: 'Bizonytalan', Bizonytalan: 'Nincs egyértelmű tipp' };
        const outcomeColor = { homeWin: 'text-green-400', draw: 'text-yellow-400', awayWin: 'text-red-400', uncertain: 'text-gray-400', Bizonytalan: 'text-gray-400'};

        if (finalTip.prediction === 'Bizonytalan') {
            aiResultDiv.innerHTML = `<div class="p-4 bg-gray-700 rounded-lg"><h3 class="font-bold text-xl ${outcomeColor[finalTip.prediction]}">Nincs egyértelmű tipp</h3><p class="text-gray-300 text-sm mt-2">${finalTip.reason}</p></div>`;
        } else {
            aiResultDiv.innerHTML = `<div class="p-4 bg-gray-700 rounded-lg"><p class="text-sm text-teal-400 font-bold uppercase tracking-wider">A Javasolt Tipp</p><h3 class="font-bold text-3xl mt-1 ${outcomeColor[finalTip.prediction]}">${outcomeMap[finalTip.prediction]}</h3><p class="text-gray-300 text-sm mt-3 pt-3 border-t border-gray-600">${finalTip.reason}</p></div>`;
        }
    }, 500);
};


// --- PAGE ROUTING & AUTH SIMULATION ---
const showPage = (pageToShow) => {
    loginPage.style.display = 'none';
    waitingRoomPage.classList.add('hidden'); // Use class to hide
    appPage.style.display = 'none';

    if (pageToShow === 'login') loginPage.style.display = 'flex';
    if (pageToShow === 'waiting') {
        waitingRoomPage.style.display = 'flex';
        waitingRoomPage.classList.remove('hidden');
    }
    if (pageToShow === 'app') appPage.style.display = 'block';
};

const checkWaitingRoom = () => {
    const status = localStorage.getItem('waitingRoomStatus');
    const isLoggedIn = !!sessionStorage.getItem('loggedInUser');

    if (status === 'open' && isLoggedIn) {
        if (waitingRoomInterval) clearInterval(waitingRoomInterval);
        waitingRoomInterval = null;
        showPage('app');
    } else if (status === 'closed' && appPage.style.display === 'block') {
        showPage('waiting');
        startWaitingRoomCheck();
    }
};

const startWaitingRoomCheck = () => {
    if (waitingRoomInterval) clearInterval(waitingRoomInterval);
    checkWaitingRoom(); 
    waitingRoomInterval = setInterval(checkWaitingRoom, 2000);
};

// --- EVENT LISTENERS ---
loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = e.target.elements.name.value;
    sessionStorage.setItem('loggedInUser', name); // JAVÍTVA
    appWelcomeUser.textContent = `Szia, ${name}!`;
    showPage('waiting');
    startWaitingRoomCheck();
});

logoutBtn.addEventListener('click', () => {
    sessionStorage.removeItem('loggedInUser'); // JAVÍTVA
    if (waitingRoomInterval) clearInterval(waitingRoomInterval);
    showPage('login');
});

document.querySelectorAll('.ai-input, .vsport-mode').forEach(input => {
    input.addEventListener('input', () => {
        clearTimeout(analysisTimeout);
        analysisTimeout = setTimeout(runAIAnalysis, 500);
    });
});

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    loadFromLocalStorage();
    const loggedInUser = sessionStorage.getItem('loggedInUser'); // JAVÍTVA
    if (loggedInUser) {
        appWelcomeUser.textContent = `Szia, ${loggedInUser}!`;
        showPage('waiting');
        startWaitingRoomCheck();
    } else {
        showPage('login');
    }

    window.addEventListener('storage', (event) => {
        if (event.key === 'waitingRoomStatus') {
            checkWaitingRoom();
        }
    });
});
</script>

</body>
</html>
