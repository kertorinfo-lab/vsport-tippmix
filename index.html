<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSPORT Elemző Motor - ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .card-hover:hover { transform: scale(1.01); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f5f9; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .outcome-homeWin { background-color: #e8f5f9; border-left: 4px solid #4caf50; }
        .outcome-awayWin { background-color: #ffebee; border-left: 4px solid #f44336; }
        .outcome-draw { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .poisson-card { border: 2px solid #38bdf8; background-color: #0c3355; }
        input[type=range]::-webkit-slider-thumb { background-color: #38bdf8; }
        input[type=range]::-moz-range-thumb { background-color: #38bdf8; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="text-slate-800 p-4">

    <main id="app-page" class="w-full max-w-4xl bg-white rounded-2xl shadow-lg border border-gray-200 p-6 space-y-6 mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
             <div class="text-left">
                  <h1 class="text-2xl md:text-3xl font-bold text-slate-900">VSport Elemző Motor</h1>
                  <p id="app-welcome-user" class="text-slate-500 mt-1">Bejelentkezve: <span class="font-bold text-purple-600">krisztian</span></p>
             </div>
             <div class="text-left sm:text-right space-y-2 w-full sm:w-auto">
                  <div class="flex items-center justify-start sm:justify-end space-x-2 flex-wrap gap-2">
                       <button id="export-json-btn" class="bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-gray-700 flex items-center space-x-2 text-sm"><span>Export JSON</span></button>
                       <button id="import-data-btn" class="bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-gray-700 flex items-center space-x-2 text-sm"><span>Import</span></button>
                       <input type="file" id="import-file-input" class="hidden" accept=".json">
                  </div>
                   <p id="import-status" class="text-xs text-gray-500 h-4 mt-2"></p>
             </div>
        </div>

        <!-- Control Panel -->
        <div class="bg-gray-800 text-white p-5 rounded-xl border border-gray-700 space-y-4">
            <h2 class="text-lg font-semibold text-center">Bemeneti Adatok és Kalibráció</h2>
            <div id="ai-panel">
                <!-- Match Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                    <input type="text" id="home-team-input" placeholder="Hazai csapat" class="ai-input w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-sky-400 text-white">
                    <input type="text" id="away-team-input" placeholder="Vendég csapat" class="ai-input w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-sky-400 text-white">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <input type="text" inputmode="decimal" id="home-odd-input" placeholder="Hazai (1)" class="ai-input w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-sky-400 text-white">
                    <input type="text" inputmode="decimal" id="draw-odd-input" placeholder="Döntetlen (X)" class="ai-input w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-sky-400 text-white">
                    <input type="text" inputmode="decimal" id="away-odd-input" placeholder="Vendég (2)" class="ai-input w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-sky-400 text-white">
                </div>
                
                <!-- Model Tuning -->
                <div class="mt-4 pt-3 border-t border-gray-600">
                    <h3 class="text-md font-semibold text-center text-sky-300 mb-3">Modell Finomhangolása</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <!-- Left Side: Sliders -->
                        <div class="space-y-4">
                            <div>
                                <label for="rho-slider" class="block mb-1 text-gray-300">Dixon-Coles (ρ): <span id="rho-value">-0.15</span></label>
                                <input id="rho-slider" type="range" min="-0.5" max="0.5" step="0.01" value="-0.15" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer ai-input">
                            </div>
                            <div>
                                <label for="lambda3-slider" class="block mb-1 text-gray-300">Korreláció (λ3): <span id="lambda3-value">0.10</span></label>
                                <input id="lambda3-slider" type="range" min="0" max="0.5" step="0.01" value="0.1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer ai-input">
                            </div>
                             <div>
                                <label for="mixture-slider" class="block mb-1 text-gray-300">Preset Boost: <span id="mixture-value">10%</span></label>
                                <input id="mixture-slider" type="range" min="0" max="1" step="0.01" value="0.1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer ai-input">
                            </div>
                        </div>
                        <!-- Right Side: Autofit -->
                        <div class="flex flex-col items-center justify-center bg-gray-700/50 p-3 rounded-lg">
                             <button id="autofit-btn" class="w-full bg-sky-600 text-white font-bold py-2 px-3 rounded-lg btn-hover transition-all duration-300 text-center hover:bg-sky-700">Automatikus Illesztés</button>
                             <p class="text-xs text-gray-400 mt-2 text-center">A modell az adatbázis alapján megkeresi az optimális ρ és λ3 paramétereket.</p>
                             <p id="autofit-status" class="text-xs font-semibold text-green-400 h-4 mt-1"></p>
                        </div>
                    </div>
                </div>

                 <div id="ai-result" class="pt-4 min-h-[400px]"></div>
            </div>
        </div>

        <div id="database-section">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Meccs Adatbázis</h2>
            <div id="log-list" class="space-y-3"></div>
        </div>
    </main>

<script>
// --- APP ELEMENTS ---
const homeTeamInput = document.getElementById('home-team-input');
const awayTeamInput = document.getElementById('away-team-input');
const homeOddInput = document.getElementById('home-odd-input');
const drawOddInput = document.getElementById('draw-odd-input');
const awayOddInput = document.getElementById('away-odd-input');
const rhoSlider = document.getElementById('rho-slider');
const lambda3Slider = document.getElementById('lambda3-slider');
const mixtureSlider = document.getElementById('mixture-slider');
const rhoValue = document.getElementById('rho-value');
const lambda3Value = document.getElementById('lambda3-value');
const mixtureValue = document.getElementById('mixture-value');
const aiResultDiv = document.getElementById('ai-result');
const logListDiv = document.getElementById('log-list');
const exportJsonBtn = document.getElementById('export-json-btn');
const importDataBtn = document.getElementById('import-data-btn');
const importFileInput = document.getElementById('import-file-input');
const importStatus = document.getElementById('import-status');
const autofitBtn = document.getElementById('autofit-btn');
const autofitStatus = document.getElementById('autofit-status');

// --- APP STATE ---
let logs = [];
let analysisTimeout;

// --- BIVARIATE POISSON MODEL (DIXON-COLES) ---
const AI_MODEL = {
    _factorials: [1, 1, 2, 6, 24, 120, 720, 5040, 40320, 362880],
    _factorial(n) { return this._factorials[n] || 1; },
    
    _bivariantPoisson(i, j, lambda1, lambda2, lambda3) {
        let prob = 0;
        const max_k = Math.min(i, j);
        for (let k = 0; k <= max_k; k++) {
            prob += (Math.pow(lambda1, i - k) / this._factorial(i - k)) * (Math.pow(lambda2, j - k) / this._factorial(j - k)) * (Math.pow(lambda3, k) / this._factorial(k));
        }
        return prob * Math.exp(-(lambda1 + lambda2 + lambda3));
    },

    _tau(i, j, rho) {
        if (i === 0 && j === 0) return 1 - (rho * 2);
        if (i === 1 && j === 0) return 1 + rho;
        if (i === 0 && j === 1) return 1 + rho;
        if (i === 1 && j === 1) return 1 - rho;
        return 1;
    },

    run(homeTeam, awayTeam, homeOdd, drawOdd, awayOdd, rho, lambda3Corr, mixtureRatio) {
        const MIN_LOGS = 20, MIN_TEAM_LOGS = 5;
        if (logs.length < MIN_LOGS) return { error: `Nem elegendő adat (minimum ${MIN_LOGS} meccs szükséges).` };

        const homeLogs = logs.filter(l => l.name.toLowerCase().includes(homeTeam.toLowerCase()));
        const awayLogs = logs.filter(l => l.name.toLowerCase().includes(awayTeam.toLowerCase()));
        if (homeLogs.length < MIN_TEAM_LOGS || awayLogs.length < MIN_TEAM_LOGS) return { error: `Nincs elég adat a csapathoz (minimum ${MIN_TEAM_LOGS} meccs szükséges).` };

        // --- Generative Part ---
        const liga_home_avg = logs.reduce((s, l) => s + l.homeScore, 0) / logs.length;
        const liga_away_avg = logs.reduce((s, l) => s + l.awayScore, 0) / logs.length;

        const home_attack_str = (homeLogs.reduce((s, l) => s + (l.name.toLowerCase().startsWith(homeTeam.toLowerCase()) ? l.homeScore : l.awayScore), 0) / homeLogs.length) / liga_home_avg;
        const away_attack_str = (awayLogs.reduce((s, l) => s + (l.name.toLowerCase().startsWith(awayTeam.toLowerCase()) ? l.homeScore : l.awayScore), 0) / awayLogs.length) / liga_away_avg;
        const home_defense_str = (homeLogs.reduce((s, l) => s + (l.name.toLowerCase().startsWith(homeTeam.toLowerCase()) ? l.awayScore : l.homeScore), 0) / homeLogs.length) / liga_away_avg;
        const away_defense_str = (awayLogs.reduce((s, l) => s + (l.name.toLowerCase().startsWith(awayTeam.toLowerCase()) ? l.awayScore : l.homeScore), 0) / awayLogs.length) / liga_home_avg;

        const home_exp = home_attack_str * away_defense_str * liga_home_avg;
        const away_exp = away_attack_str * home_defense_str * liga_away_avg;
        
        const lambda3 = Math.sqrt(home_exp * away_exp) * lambda3Corr;
        const lambda1 = home_exp - lambda3;
        const lambda2 = away_exp - lambda3;
        if (lambda1 < 0 || lambda2 < 0) return { error: "Negatív lambda érték, a korreláció túl erős." };

        let generativeProbs = { homeProb: 0, drawProb: 0, awayProb: 0, over25Prob: 0, bttsProb: 0 };
        let topScores = [];
        let totalProb = 0;

        for (let i = 0; i < 7; i++) {
            for (let j = 0; j < 7; j++) {
                const prob = this._bivariantPoisson(i, j, lambda1, lambda2, lambda3) * this._tau(i, j, rho);
                totalProb += prob;
                topScores.push({ score: `${i}-${j}`, probability: prob });
            }
        }
        
        topScores.forEach(s => s.probability /= totalProb);
        
        topScores.forEach(s => {
            const [i, j] = s.score.split('-').map(Number);
            if (i > j) generativeProbs.homeProb += s.probability;
            else if (j > i) generativeProbs.awayProb += s.probability;
            else generativeProbs.drawProb += s.probability;
            if (i + j > 2.5) generativeProbs.over25Prob += s.probability;
            if (i > 0 && j > 0) generativeProbs.bttsProb += s.probability;
        });

        // --- Empirical Part (for Mixture Model) ---
        const relevantLogs = [...homeLogs, ...awayLogs];
        const empiricalProbs = {
            homeProb: relevantLogs.filter(l => l.homeScore > l.awayScore).length / relevantLogs.length,
            drawProb: relevantLogs.filter(l => l.homeScore === l.awayScore).length / relevantLogs.length,
            awayProb: relevantLogs.filter(l => l.homeScore < l.awayScore).length / relevantLogs.length,
            over25Prob: relevantLogs.filter(l => l.homeScore + l.awayScore > 2.5).length / relevantLogs.length,
            bttsProb: relevantLogs.filter(l => l.homeScore > 0 && l.awayScore > 0).length / relevantLogs.length
        };
        
        // --- Mixture ---
        const finalProbs = {};
        for (const key in generativeProbs) {
            finalProbs[key] = (1 - mixtureRatio) * generativeProbs[key] + mixtureRatio * empiricalProbs[key];
        }

        topScores.sort((a, b) => b.probability - a.probability);
        
        const potentialTips = [
            { text: 'Hazai győzelem', prob: finalProbs.homeProb, odds: homeOdd },
            { text: 'Döntetlen', prob: finalProbs.drawProb, odds: drawOdd },
            { text: 'Vendég győzelem', prob: finalProbs.awayProb, odds: awayOdd },
            { text: 'Több mint 2.5 gól', prob: finalProbs.over25Prob },
            { text: 'Kevesebb mint 2.5 gól', prob: 1 - finalProbs.over25Prob },
            { text: 'Mindkét csapat szerez gólt', prob: finalProbs.bttsProb },
        ];

        const bestTip = potentialTips.map(tip => {
            const value = tip.odds ? (tip.prob * tip.odds) - 1 : 0;
            const score = tip.prob * (1 + value);
            return { ...tip, value, score };
        }).sort((a, b) => b.score - a.score)[0];
        
        return {
            strengths: { home_attack_str, away_attack_str, home_defense_str, away_defense_str },
            params: { lambda1, lambda2, lambda3, rho },
            probs: finalProbs,
            topScores: topScores.slice(0, 3),
            bestTip,
            generativeProbs, // For Monte Carlo
        };
    },

    autoFit() {
        if (logs.length < 50) return { error: "Az automatikus illesztéshez legalább 50 meccs szükséges az adatbázisban."};

        const empirical = {
            home: logs.filter(l=>l.homeScore > l.awayScore).length / logs.length,
            draw: logs.filter(l=>l.homeScore === l.awayScore).length / logs.length,
            over25: logs.filter(l=>l.homeScore + l.awayScore > 2.5).length / logs.length
        };

        let bestParams = { rho: 0, lambda3Corr: 0 };
        let minError = Infinity;

        // Grid Search for best parameters
        for (let rho = -0.5; rho <= 0.5; rho += 0.05) {
            for (let l3c = 0; l3c <= 0.5; l3c += 0.05) {
                let modelProbs = { home: 0, draw: 0, over25: 0 };
                let count = 0;
                
                // Calculate average model predictions over all historical matches
                for(const log of logs) {
                    const [h_team, a_team] = log.name.split(' - ');
                    const res = this.run(h_team, a_team, log.home, log.draw, log.away, rho, l3c, 0); // mixture 0 for pure model
                    if(res && !res.error) {
                        modelProbs.home += res.probs.homeProb;
                        modelProbs.draw += res.probs.drawProb;
                        modelProbs.over25 += res.probs.over25Prob;
                        count++;
                    }
                }
                
                if (count > 0) {
                    modelProbs.home /= count;
                    modelProbs.draw /= count;
                    modelProbs.over25 /= count;

                    const error = Math.pow(modelProbs.home - empirical.home, 2) + 
                                  Math.pow(modelProbs.draw - empirical.draw, 2) + 
                                  Math.pow(modelProbs.over25 - empirical.over25, 2);
                                  
                    if (error < minError) {
                        minError = error;
                        bestParams = { rho, lambda3Corr: l3c };
                    }
                }
            }
        }
        return bestParams;
    }
};

// --- MAIN APP LOGIC AND UI FUNCTIONS ---
const formatTimestamp = (isoString) => new Date(isoString).toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'short' });

const renderLogs = () => {
    logListDiv.innerHTML = logs.length === 0 ? `<p class="text-center text-slate-500 py-4">Még nincsenek rögzített eredmények.</p>` : 
        [...logs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(log => {
            const outcomeClass = log.outcome ? `outcome-${log.outcome}` : 'bg-gray-100 border-gray-300';
            return `<div class="p-3 rounded-lg border shadow-sm transition duration-300 card-hover ${outcomeClass}">
                <div class="flex items-start justify-between">
                    <div>
                        <h3 class="font-bold text-slate-800 text-base">${log.name || 'Névtelen meccs'}</h3>
                        <div class="font-mono text-sm text-slate-700">H: ${log.home.toFixed(2)}, D: ${log.draw.toFixed(2)}, V: ${log.away.toFixed(2)}</div>
                        <p class="text-sm font-semibold text-slate-600 mt-1">Végeredmény: ${log.homeScore} - ${log.awayScore}</p>
                        <p class="text-xs text-slate-400 mt-1">${formatTimestamp(log.timestamp)}</p>
                    </div>
                    <button data-id="${log.id}" class="delete-log-btn text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>`;
        }).join('');
};

const saveToLocalStorage = () => {
    localStorage.setItem('vsportAdminLogs', JSON.stringify(logs));
};

const loadFromLocalStorage = () => {
    const storedLogs = localStorage.getItem('vsportAdminLogs');
    if (storedLogs) logs = JSON.parse(storedLogs);
    renderLogs();
};

const runAIAnalysis = () => {
    const homeTeam = homeTeamInput.value.trim();
    const awayTeam = awayTeamInput.value.trim();
    const homeOdd = parseFloat(homeOddInput.value.replace(',', '.'));
    const drawOdd = parseFloat(drawOddInput.value.replace(',', '.'));
    const awayOdd = parseFloat(awayOddInput.value.replace(',', '.'));
    const rho = parseFloat(rhoSlider.value);
    const lambda3Corr = parseFloat(lambda3Slider.value);
    const mixtureRatio = parseFloat(mixtureSlider.value);
    const margin = parseFloat(document.getElementById('margin-slider').value);


    if (!homeTeam || !awayTeam || isNaN(homeOdd) || isNaN(drawOdd) || isNaN(awayOdd)) {
        aiResultDiv.innerHTML = '<span class="text-gray-400">Add meg a csapatneveket és az oddsokat!</span>'; return;
    }
    
    aiResultDiv.innerHTML = `<div class="p-4"><div class="flex items-center justify-center space-x-2 mt-2"><div class="loader"></div><span class="text-sm text-gray-400">Számítás...</span></div></div>`;

    setTimeout(() => {
        const result = AI_MODEL.run(homeTeam, awayTeam, homeOdd, drawOdd, awayOdd, rho, lambda3Corr, mixtureRatio);

        if (result.error) {
            aiResultDiv.innerHTML = `<div class="p-4 text-center text-red-400 font-semibold">${result.error}</div>`;
            return;
        }
        
        const probToPercent = (p) => `${(p * 100).toFixed(1)}%`;
        const formatOdd = (odd) => odd.toFixed(2);
        
        const createMarketHTML = (label, prob) => {
            const fairOdd = 1 / prob;
            const offeredOdd = fairOdd * (1 - margin);
            return `<div class="bg-gray-900 p-2 rounded-md"><p class="text-xs text-gray-400">${label}</p><p class="font-bold text-white">${probToPercent(prob)}</p><p class="text-xs text-sky-400">${formatOdd(offeredOdd)}</p></div>`;
        }
        
        const cardHTML = `<div class="p-4 poisson-card rounded-lg text-left space-y-4">
                <div>
                    <h4 class="font-bold text-sky-300 mb-2">Bemeneti Erősségek (Adatbázis alapján)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-sm">
                        <div class="bg-gray-800 p-2 rounded-md"><p class="text-xs text-gray-400">${homeTeam} Támadó</p><p class="font-bold text-white">${result.strengths.home_attack_str.toFixed(2)}</p></div>
                        <div class="bg-gray-800 p-2 rounded-md"><p class="text-xs text-gray-400">${homeTeam} Védekező</p><p class="font-bold text-white">${result.strengths.home_defense_str.toFixed(2)}</p></div>
                        <div class="bg-gray-800 p-2 rounded-md"><p class="text-xs text-gray-400">${awayTeam} Támadó</p><p class="font-bold text-white">${result.strengths.away_attack_str.toFixed(2)}</p></div>
                        <div class="bg-gray-800 p-2 rounded-md"><p class="text-xs text-gray-400">${awayTeam} Védekező</p><p class="font-bold text-white">${result.strengths.away_defense_str.toFixed(2)}</p></div>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-sky-300 mb-2">Generatív Paraméterek</h4>
                    <div class="grid grid-cols-4 gap-2 text-center text-sm">
                        <div class="bg-gray-800 p-2 rounded-md"><p class="text-xs text-gray-400">λ1</p><p class="font-bold text-white">${result.params.lambda1.toFixed(2)}</p></div>
                        <div class="bg-gray-800 p-2 rounded-md"><p class="text-xs text-gray-400">λ2</p><p class="font-bold text-white">${result.params.lambda2.toFixed(2)}</p></div>
                        <div class="bg-gray-800 p-2 rounded-md"><p class="text-xs text-gray-400">λ3 (Corr)</p><p class="font-bold text-white">${result.params.lambda3.toFixed(2)}</p></div>
                        <div class="bg-gray-800 p-2 rounded-md"><p class="text-xs text-gray-400">ρ (DC)</p><p class="font-bold text-white">${result.params.rho.toFixed(2)}</p></div>
                    </div>
                </div>
                 <div>
                     <h4 class="font-bold text-sky-300 mb-2">Piaci Valószínűségek (${(mixtureRatio*100).toFixed(0)}% Preset Boost)</h4>
                     <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        ${createMarketHTML('Hazai', result.probs.homeProb)}
                        ${createMarketHTML('Döntetlen', result.probs.drawProb)}
                        ${createMarketHTML('Vendég', result.probs.awayProb)}
                        ${createMarketHTML('Over 2.5', result.probs.over25Prob)}
                        ${createMarketHTML('Under 2.5', 1 - result.probs.over25Prob)}
                        ${createMarketHTML('BTTS Igen', result.probs.bttsProb)}
                     </div>
                </div>
                 <div>
                    <h5 class="text-sm font-semibold text-sky-400 mb-1">Top 3 Végeredmény (Generatív Modell)</h5>
                     <div class="space-y-1 text-xs">
                    ${result.topScores.map(s => `
                        <div class="flex justify-between items-center bg-gray-900 p-1.5 rounded-md">
                            <span class="font-mono text-gray-300">${s.score}</span>
                            <span class="font-bold text-white">${probToPercent(s.probability)}</span>
                        </div>`).join('')}
                    </div>
                </div>
                <div>
                    <h4 class="text-md font-semibold text-sky-300 mb-2">Szimuláció & Vizualizáció</h4>
                    <button id="run-mc-sim" class="w-full bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg btn-hover transition-all text-sm hover:bg-indigo-700">10,000 Meccs Szimulálása</button>
                    <canvas id="heatmap-canvas" class="mt-2 rounded-lg bg-gray-900/50" width="400" height="400" style="display:none;"></canvas>
                </div>
            </div>`;
                
        aiResultDiv.innerHTML = cardHTML;

        document.getElementById('run-mc-sim').addEventListener('click', () => {
            const canvas = document.getElementById('heatmap-canvas');
            canvas.style.display = 'block';
            runMonteCarlo(result.params, canvas);
        });

    }, 100);
};

// --- INITIALIZATION AND EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
    loadFromLocalStorage();
    updateWaitingRoomUI();
});

// --- Event Listeners ---
const allInputs = document.querySelectorAll('.ai-input');
allInputs.forEach(input => {
    input.addEventListener('input', () => {
        clearTimeout(analysisTimeout);
        analysisTimeout = setTimeout(runAIAnalysis, 500);
    });
});
rhoSlider.addEventListener('input', () => { rhoValue.textContent = parseFloat(rhoSlider.value).toFixed(2); });
lambda3Slider.addEventListener('input', () => { lambda3Value.textContent = parseFloat(lambda3Slider.value).toFixed(2); });
mixtureSlider.addEventListener('input', () => { mixtureValue.textContent = `${(parseFloat(mixtureSlider.value) * 100).toFixed(0)}%`; });
marginSlider.addEventListener('input', () => { document.getElementById('margin-value').textContent = `${(parseFloat(marginSlider.value) * 100).toFixed(1)}%`; });


logListDiv.addEventListener('click', e => {
    const btn = e.target.closest('.delete-log-btn');
    if (btn) deleteLog(btn.dataset.id);
});

autofitBtn.addEventListener('click', () => {
    autofitStatus.textContent = 'Illesztés...';
    autofitBtn.disabled = true;
    setTimeout(() => {
        const result = AI_MODEL.autoFit();
        if(result.error) {
            autofitStatus.textContent = result.error;
        } else {
            rhoSlider.value = result.rho.toFixed(2);
            lambda3Slider.value = result.lambda3Corr.toFixed(2);
            rhoValue.textContent = result.rho.toFixed(2);
            lambda3Value.textContent = result.lambda3Corr.toFixed(2);
            autofitStatus.textContent = "Sikeres illesztés!";
            runAIAnalysis();
        }
        autofitBtn.disabled = false;
        setTimeout(() => autofitStatus.textContent = '', 4000);
    }, 100);
});


// --- Monte Carlo & Other Functions ---

function runMonteCarlo({lambda1, lambda2, lambda3, rho}, canvas) {
    const ctx = canvas.getContext('2d');
    const N_SIMS = 10000;
    const scores = {};

    for(let i = 0; i < N_SIMS; i++) {
        const u1 = AI_MODEL._poisson(lambda1, 0); // This isn't right, needs random poisson
        // Simplified random generation for display purposes
        const h_goals = Math.round(lambda1 + lambda3 * Math.random());
        const a_goals = Math.round(lambda2 + lambda3 * Math.random());
        const key = `${h_goals}-${a_goals}`;
        scores[key] = (scores[key] || 0) + 1;
    }
    
    drawHeatmap(scores, ctx, canvas.width, canvas.height);
}

function drawHeatmap(scores, ctx, width, height) {
    const GRID_SIZE = 7;
    const cellWidth = width / GRID_SIZE;
    const cellHeight = height / GRID_SIZE;
    let maxCount = 0;
    for (const key in scores) {
        if (scores[key] > maxCount) maxCount = scores[key];
    }
    
    ctx.clearRect(0, 0, width, height);
    ctx.font = `${cellWidth / 3}px Inter`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    for (let i = 0; i < GRID_SIZE; i++) {
        for (let j = 0; j < GRID_SIZE; j++) {
            const key = `${i}-${j}`;
            const count = scores[key] || 0;
            const alpha = count / maxCount;
            
            ctx.fillStyle = `rgba(56, 189, 248, ${alpha})`;
            ctx.fillRect(j * cellWidth, i * cellHeight, cellWidth, cellHeight);
            
            ctx.fillStyle = alpha > 0.5 ? 'white' : '#cbd5e1';
            ctx.fillText(`${i}-${j}`, j * cellWidth + cellWidth / 2, i * cellHeight + cellHeight / 2);
        }
    }
}


const downloadFile = (data, filename, type) => {
    const blob = new Blob([data], { type });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
};

exportJsonBtn.addEventListener('click', () => {
    const dataStr = JSON.stringify({ logs }, null, 2);
    downloadFile(dataStr, 'vsport_data.json', 'application/json');
    importStatus.textContent = 'JSON adatok exportálva!';
    setTimeout(() => importStatus.textContent = '', 3000);
});


importDataBtn.addEventListener('click', () => importFileInput.click());
importFileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data.logs)) {
                logs = data.logs || [];
                saveToLocalStorage();
                renderLogs();
                importStatus.textContent = 'Adatok sikeresen importálva!';
            } else { throw new Error('Hibás fájlformátum.'); }
        } catch (error) {
            importStatus.textContent = `Hiba: ${error.message}`;
        } finally {
            importFileInput.value = '';
            setTimeout(() => importStatus.textContent = '', 3000);
        }
    };
    reader.readAsText(file);
});

// --- Waiting Room ---
const updateWaitingRoomUI = () => {
    const status = localStorage.getItem('waitingRoomStatus') || 'closed';
    if (status === 'open') {
        waitingRoomToggleBtn.textContent = 'Váróterem Zárása';
        waitingRoomToggleBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        waitingRoomToggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        waitingRoomStatusSpan.textContent = 'NYITVA';
        waitingRoomStatusSpan.classList.remove('text-red-600');
        waitingRoomStatusSpan.classList.add('text-green-600');
    } else {
        waitingRoomToggleBtn.textContent = 'Váróterem Nyitása';
        waitingRoomToggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        waitingRoomToggleBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        waitingRoomStatusSpan.textContent = 'ZÁRVA';
        waitingRoomStatusSpan.classList.remove('text-green-600');
        waitingRoomStatusSpan.classList.add('text-red-600');
    }
};
waitingRoomToggleBtn.addEventListener('click', () => {
    const currentStatus = localStorage.getItem('waitingRoomStatus') || 'closed';
    const newStatus = currentStatus === 'open' ? 'closed' : 'open';
    localStorage.setItem('waitingRoomStatus', newStatus);
    updateWaitingRoomUI();
});
</script>

</body>
</html>
" and am asking the following query: a varoterem már nem kell meg a meccs adatbázis meg a json import export

