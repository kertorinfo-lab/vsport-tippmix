<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSPORT Football</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .card-hover:hover {
            transform: scale(1.01);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        ::-webkit-scrollbar { width: 8px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .outcome-homeWin { background-color: #e8f5f9; border-left: 4px solid #4caf50; }
        .outcome-awayWin { background-color: #ffebee; border-left: 4px solid #f44336; }
        .outcome-draw { background-color: #fff3e0; border-left: 4px solid #ff9800; }

        .tab { transition: all 0.2s ease-in-out; }
        .tab.active { background-color: white; border-color: #e5e7eb; border-bottom-color: white; transform: translateY(-2px); }
        .tab-panel, .ai-tab-panel { display: none; }
        .tab-panel.active, .ai-tab-panel.active { display: block; }
        
        #stats-modal { transition: opacity 0.3s ease-in-out; }
        #stats-modal.hidden { pointer-events: none; }
        
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        
        .scrollable-tabs {
            flex-wrap: nowrap;
            overflow-x: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #4b5563 #1f2937; /* Firefox */
        }
        .scrollable-tabs::-webkit-scrollbar-track { background: #1f2937; }
        .scrollable-tabs::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }


        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="text-slate-800 p-4">

    <!-- App Page -->
    <main id="app-page" class="w-full max-w-4xl bg-white rounded-2xl shadow-lg border border-gray-200 p-6 space-y-6 mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
             <div class="text-left">
                 <h1 class="text-2xl md:text-3xl font-bold text-slate-900">Odds Elemző</h1>
                 <p id="app-welcome-user" class="text-slate-500 mt-1">Helyi Mód</p>
             </div>
             <div class="text-left sm:text-right space-y-2 w-full sm:w-auto">
                 <div class="flex items-center justify-start sm:justify-end space-x-2 flex-wrap gap-2">
                     <button id="export-json-btn" class="bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-gray-700 flex items-center space-x-2 text-sm">
                         <span>Export JSON</span>
                     </button>
                      <button id="export-csv-btn" class="bg-teal-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-teal-700 flex items-center space-x-2 text-sm">
                         <span>Export CSV</span>
                     </button>
                     <button id="import-data-btn" class="bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-gray-700 flex items-center space-x-2 text-sm">
                         <span>Import</span>
                     </button>
                     <input type="file" id="import-file-input" class="hidden" accept=".json">
                     <button id="open-stats-btn" class="bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-blue-700 flex items-center space-x-2 text-sm">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                         <span>Statisztika</span>
                     </button>
                 </div>
                  <p id="import-status" class="text-xs text-gray-500 h-4 mt-2"></p>
             </div>
        </div>

        <div id="main-grid" class="grid grid-cols-1 lg:gap-6 space-y-6 lg:space-y-0">
            <div class="bg-gray-800 text-white p-5 rounded-xl border border-gray-700 space-y-4 flex flex-col">
                <h2 class="text-lg font-semibold text-center">AI Elemző</h2>
                <div class="flex border-b border-gray-600">
                    <div id="ai-tabs-container" class="flex items-center scrollable-tabs"></div>
                    <button id="add-ai-tab-btn" class="ml-2 px-3 py-1 text-lg font-bold text-gray-400 hover:bg-gray-700 rounded-full transition shrink-0">+</button>
                </div>
                <div id="ai-panels-container"></div>
            </div>
        </div>

        <div id="database-section">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Lezárt Meccsek (Adatbázis)</h2>
            <div id="log-list" class="space-y-3"></div>
        </div>
    </main>

    <!-- Statisztika Modal -->
    <div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-3xl max-h-[90vh] rounded-xl shadow-2xl flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800">Modellek Teljesítménye</h2>
                <button id="close-stats-btn" class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="stats-content" class="p-6 overflow-y-auto space-y-6"></div>
        </div>
    </div>

<script>
    // --- APP ELEMENTS ---
    const appWelcomeUser = document.getElementById('app-welcome-user');
    const mainGrid = document.getElementById('main-grid');
    const databaseSection = document.getElementById('database-section');
    const aiTabsContainer = document.getElementById('ai-tabs-container');
    const aiPanelsContainer = document.getElementById('ai-panels-container');
    const addAITabBtn = document.getElementById('add-ai-tab-btn');
    const logListDiv = document.getElementById('log-list');
    const statsModal = document.getElementById('stats-modal');
    const openStatsBtn = document.getElementById('open-stats-btn');
    const closeStatsBtn = document.getElementById('close-stats-btn');
    const statsContent = document.getElementById('stats-content');
    const exportJsonBtn = document.getElementById('export-json-btn');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFileInput = document.getElementById('import-file-input');
    const importStatus = document.getElementById('import-status');


    // --- APP STATE ---
    let logs = [];
    let predictionsLog = [];
    let activeAITabId = null;
    let analysisTimeout;

    // --- MATH & AI MODELS ---

    const FACTORIALS = [1, 1, 2, 6, 24, 120, 720, 5040, 40320, 362880];
    const poissonProbability = (k, lambda) => {
        if (k >= FACTORIALS.length || lambda < 0) return 0;
        return (Math.pow(lambda, k) * Math.exp(-lambda)) / FACTORIALS[k];
    };

    const model_Statistical_Analyst = (homeTeam, awayTeam) => {
        if (logs.length < 5) return { 
            prediction: 'uncertain', 
            predictedScore: '?-?', 
            reason: 'Nincs elég adat (minimum 5 meccs szükséges) a statisztikai elemzéshez.', 
            pattern: 'Nincs Adat' 
        };

        let totalHomeGoals = 0, totalAwayGoals = 0, matchCount = logs.length;
        logs.forEach(l => { totalHomeGoals += l.homeScore; totalAwayGoals += l.awayScore; });
        const avgHomeGoals = totalHomeGoals / matchCount;
        const avgAwayGoals = totalAwayGoals / matchCount;
        
        const h2hLogs = logs.filter(l => {
            const teams = l.name.split(' - ').map(t => t.trim().toLowerCase());
            return (teams[0] === homeTeam.toLowerCase() && teams[1] === awayTeam.toLowerCase()) ||
                   (teams[0] === awayTeam.toLowerCase() && teams[1] === homeTeam.toLowerCase());
        });
        let h2hHomeWins = 0, h2hAwayWins = 0, h2hDraws = 0;
        h2hLogs.forEach(l => {
            const teams = l.name.split(' - ').map(t => t.trim().toLowerCase());
            if (teams[0] === homeTeam.toLowerCase()) {
                if (l.outcome === 'homeWin') h2hHomeWins++; else if (l.outcome === 'awayWin') h2hAwayWins++; else h2hDraws++;
            } else {
                if (l.outcome === 'awayWin') h2hHomeWins++; else if (l.outcome === 'homeWin') h2hAwayWins++; else h2hDraws++;
            }
        });

        const getTeamForm = (teamName) => {
            const teamLogs = logs.filter(l => l.name.toLowerCase().includes(teamName.toLowerCase()))
                                 .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                                 .slice(0, 5);
            if (teamLogs.length === 0) return { text: "Nincs friss meccs.", goalsScored: 0, games: 0 };
            let goalsScored = 0, wins = 0, draws = 0, losses = 0, goalsConceded = 0;
            teamLogs.forEach(l => {
                const teams = l.name.split(' - ').map(t => t.trim().toLowerCase());
                const isHome = teams[0] === teamName.toLowerCase();
                if ((isHome && l.outcome === 'homeWin') || (!isHome && l.outcome === 'awayWin')) wins++;
                else if (l.outcome === 'draw') draws++; else losses++;
                goalsScored += isHome ? l.homeScore : l.awayScore;
                goalsConceded += isHome ? l.awayScore : l.homeScore;
            });
            return { text: `${wins}GY-${draws}D-${losses}V (${goalsScored}:${goalsConceded})`, goalsScored, games: teamLogs.length };
        };

        const homeForm = getTeamForm(homeTeam);
        const awayForm = getTeamForm(awayTeam);

        const getTeamStrength = (teamName) => {
            let goalsScoredHome = 0, goalsConcededHome = 0, homeGames = 0;
            let goalsScoredAway = 0, goalsConcededAway = 0, awayGames = 0;
            logs.forEach(l => {
                const teams = l.name.split(' - ').map(t => t.trim().toLowerCase());
                if (teams.length < 2) return;
                if (teams[0] === teamName) {
                    homeGames++; goalsScoredHome += l.homeScore; goalsConcededHome += l.awayScore;
                } else if (teams[1] === teamName) {
                    awayGames++; goalsScoredAway += l.awayScore; goalsConcededAway += l.homeScore;
                }
            });
            return {
                homeAttack: homeGames > 0 ? (goalsScoredHome / homeGames) / avgHomeGoals : 1,
                homeDefense: homeGames > 0 ? (goalsConcededHome / homeGames) / avgAwayGoals : 1,
                awayAttack: awayGames > 0 ? (goalsScoredAway / awayGames) / avgAwayGoals : 1,
                awayDefense: awayGames > 0 ? (goalsConcededAway / awayGames) / avgHomeGoals : 1
            };
        };
        
        const homeStrength = getTeamStrength(homeTeam.toLowerCase());
        const awayStrength = getTeamStrength(awayTeam.toLowerCase());
        
        let homeXG = homeStrength.homeAttack * awayStrength.awayDefense * avgHomeGoals;
        let awayXG = awayStrength.awayAttack * homeStrength.homeDefense * avgAwayGoals;
        
        if (homeForm.games > 0) {
            const homeFormAttackRatio = (homeForm.goalsScored / homeForm.games) / ((avgHomeGoals + avgAwayGoals)/2);
            homeXG = homeXG * 0.7 + (homeXG * homeFormAttackRatio) * 0.3;
        }
        if (awayForm.games > 0) {
            const awayFormAttackRatio = (awayForm.goalsScored / awayForm.games) / ((avgHomeGoals + avgAwayGoals)/2);
            awayXG = awayXG * 0.7 + (awayXG * awayFormAttackRatio) * 0.3;
        }
        
        let maxProb = 0;
        let predictedScore = "1-1";
        let outcomeProbs = { homeWin: 0, draw: 0, awayWin: 0 };
        for (let i = 0; i < 7; i++) {
            for (let j = 0; j < 7; j++) {
                const prob = poissonProbability(i, homeXG) * poissonProbability(j, awayXG);
                if (i > j) outcomeProbs.homeWin += prob;
                else if (j > i) outcomeProbs.awayWin += prob;
                else outcomeProbs.draw += prob;
                if (prob > maxProb) { maxProb = prob; predictedScore = `${i}-${j}`; }
            }
        }
        
        const [homeScore, awayScore] = predictedScore.split('-').map(Number);
        let winnerOutcome = (homeScore > awayScore) ? 'homeWin' : (awayScore > homeScore) ? 'awayWin' : 'draw';

        const reasons = [
            `Becsült gólok (xG): H: ${homeXG.toFixed(2)}, V: ${awayXG.toFixed(2)}`,
            `Forma (5): ${homeTeam.split(' ').pop()}: ${homeForm.text} | ${awayTeam.split(' ').pop()}: ${awayForm.text}`,
        ];
        if (h2hLogs.length > 0) {
            reasons.push(`Egymás ellen (${h2hLogs.length}): ${h2hHomeWins}H - ${h2hDraws}D - ${h2hAwayWins}V`);
        }
        reasons.push(`Esélyek: H: ${(outcomeProbs.homeWin*100).toFixed(1)}%, D: ${(outcomeProbs.draw*100).toFixed(1)}%, V: ${(outcomeProbs.awayWin*100).toFixed(1)}%`);

        return { prediction: winnerOutcome, predictedScore, reason: reasons.join('\n'), pattern: 'Poisson Statisztika', homeXG, awayXG };
    };

    const model_Odds_Based = (home, draw, away) => {
        let prediction = 'uncertain';
        let predictedScore = '?-?';
        const minOdd = Math.min(home, draw, away);

        if (isNaN(minOdd)) {
            return {
                prediction: 'uncertain',
                predictedScore: '?-?',
                reason: 'Érvénytelen oddsok megadva.',
                pattern: 'Odds Alapú'
            };
        }

        if (minOdd === home) {
            prediction = 'homeWin';
            if (home < 1.5) predictedScore = '2-0';
            else if (home < 2.2) predictedScore = '2-1';
            else predictedScore = '1-0';
        } else if (minOdd === away) {
            prediction = 'awayWin';
            if (away < 1.5) predictedScore = '0-2';
            else if (away < 2.2) predictedScore = '1-2';
            else predictedScore = '0-1';
        } else { // minOdd === draw
            prediction = 'draw';
            predictedScore = '1-1';
        }
        
        return {
            prediction,
            predictedScore,
            reason: `A legalacsonyabb odds (${minOdd}) alapján a tippelt kimenetel.`,
            pattern: 'Odds Alapú'
        };
    };
    
    const model_Hybrid_Analyst = (homeXG, awayXG, homeOdds, drawOdds, awayOdds) => {
        // Implied probabilities from odds
        const probH = 1 / homeOdds;
        const probD = 1 / drawOdds;
        const probA = 1 / awayOdds;
        const totalProb = probH + probD + probA;
        const normH = probH / totalProb;
        const normA = probA / totalProb;
        
        const oddsScore = normH - normA; // Range ~[-1, 1]
        const statScore = homeXG - awayXG;
        const normalizedStatScore = Math.tanh(statScore / 2); // Squash stat score to ~[-1, 1]

        // Weighted average of the two scores
        const hybridScore = (normalizedStatScore * 0.6) + (oddsScore * 0.4);

        let prediction = 'draw';
        if (hybridScore > 0.3) prediction = 'homeWin';
        else if (hybridScore < -0.3) prediction = 'awayWin';
        
        let predictedScore = "1-1";
        if (prediction === 'homeWin') predictedScore = hybridScore > 0.8 ? "2-0" : "2-1";
        else if (prediction === 'awayWin') predictedScore = hybridScore < -0.8 ? "0-2" : "1-2";

        return {
            prediction,
            predictedScore,
            reason: `A statisztikai (xG) és odds alapú valószínűségek ötvözete. Hibrid pontszám: ${hybridScore.toFixed(2)}.`,
            pattern: 'Hibrid Elemző'
        };
    };
    
    // --- MAIN APP LOGIC ---
    const formatTimestamp = (isoString) => new Date(isoString).toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'short' });

    const renderLogs = () => {
        logListDiv.innerHTML = logs.length === 0 ? `<p class="text-center text-slate-500 py-4">Még nincsenek rögzített eredmények.</p>` : 
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(log => {
                const outcomeClass = log.outcome ? `outcome-${log.outcome}` : 'bg-gray-100 border-gray-300';
                return `<div class="p-3 rounded-lg border shadow-sm transition duration-300 card-hover ${outcomeClass}">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="font-bold text-slate-800 text-base">${log.name || 'Névtelen meccs'}</h3>
                            <div class="font-mono text-sm text-slate-700">H: ${log.home.toFixed(2)}, D: ${log.draw.toFixed(2)}, V: ${log.away.toFixed(2)}</div>
                            <p class="text-sm font-semibold text-slate-600 mt-1">Végeredmény: ${log.homeScore} - ${log.awayScore}</p>
                            <p class="text-xs text-slate-400 mt-1">${formatTimestamp(log.timestamp)}</p>
                        </div>
                        <button data-id="${log.id}" class="delete-log-btn text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
    };

    const saveToLocalStorage = () => {
        localStorage.setItem('tippmixLogs', JSON.stringify(logs));
        localStorage.setItem('tippmixPredictionsLog', JSON.stringify(predictionsLog));
    };

    const loadFromLocalStorage = () => {
        const storedLogs = localStorage.getItem('tippmixLogs');
        const storedPredictions = localStorage.getItem('tippmixPredictionsLog');
        if (storedLogs) logs = JSON.parse(storedLogs);
        if (storedPredictions) predictionsLog = JSON.parse(storedPredictions);
        renderLogs();
    };

    const runAIAnalysis = (activePanel) => {
        if (!activePanel) return;
        const homeTeamInput = activePanel.querySelector('.ai-home-team');
        const awayTeamInput = activePanel.querySelector('.ai-away-team');
        const aiHomeInput = activePanel.querySelector('.ai-home');
        const aiDrawInput = activePanel.querySelector('.ai-draw');
        const aiAwayInput = activePanel.querySelector('.ai-away');
        const aiResultDiv = activePanel.querySelector('.ai-result');

        const home = parseFloat(aiHomeInput.value.replace(',', '.'));
        const draw = parseFloat(aiDrawInput.value.replace(',', '.'));
        const away = parseFloat(aiAwayInput.value.replace(',', '.'));
        const homeTeam = homeTeamInput.value.trim();
        const awayTeam = awayTeamInput.value.trim();

        if (isNaN(home) || isNaN(draw) || isNaN(away) || !homeTeam || !awayTeam) {
            aiResultDiv.innerHTML = '<span class="text-gray-400">Add meg a csapatneveket és az oddsokat!</span>'; return;
        }
        
        aiResultDiv.innerHTML = `<div class="p-4 space-y-3"><div class="flex items-center justify-center space-x-2 mt-2"><div class="loader"></div><span class="text-sm text-gray-400">Elemzés...</span></div></div>`;

        setTimeout(() => {
            const statisticalResult = model_Statistical_Analyst(homeTeam, awayTeam);
            const oddsResult = model_Odds_Based(home, draw, away);
            const hybridResult = (statisticalResult.homeXG !== undefined && statisticalResult.awayXG !== undefined)
                ? model_Hybrid_Analyst(statisticalResult.homeXG, statisticalResult.awayXG, home, draw, away)
                : { 
                    prediction: 'uncertain', 
                    predictedScore: '?-?', 
                    reason: 'Nem futtatható, mert a statisztikai modellhez nincs elég adat.', 
                    pattern: 'Hibrid Adathiány' 
                  };
            
            const outcomeMap = { homeWin: 'Hazai (1)', draw: 'Döntetlen (X)', awayWin: 'Vendég (2)', uncertain: 'Bizonytalan' };

            const createCardHTML = (title, result) => `
                <div class="p-3 bg-gray-700 rounded-lg text-left">
                    <h4 class="font-bold text-teal-400">${title}</h4>
                    <p class="text-2xl font-bold text-white mt-1">${result.predictedScore}</p>
                    <p class="text-sm text-teal-300">${outcomeMap[result.prediction] || 'Ismeretlen'}</p>
                    <p class="text-xs text-gray-300 whitespace-pre-wrap mt-2">${result.reason}</p>
                </div>`;
            
            const saveResultHTML = `
                <div class="p-3 bg-gray-600 rounded-lg text-left">
                    <h4 class="font-bold text-gray-300 text-sm uppercase tracking-wider mb-2">Eredmény rögzítése</h4>
                    <div class="flex items-center space-x-2">
                        <input type="number" placeholder="H" class="actual-home-score w-16 px-2 py-1 text-sm rounded-lg bg-gray-800 border border-gray-500 focus:ring-2 focus:ring-teal-400 text-white text-center">
                        <span class="text-gray-400">-</span>
                        <input type="number" placeholder="V" class="actual-away-score w-16 px-2 py-1 text-sm rounded-lg bg-gray-800 border border-gray-500 focus:ring-2 focus:ring-teal-400 text-white text-center">
                        <button class="save-result-btn ml-auto bg-purple-600 text-white font-semibold py-1 px-3 rounded-lg text-sm btn-hover hover:bg-purple-700">Mentés</button>
                    </div>
                    <div class="result-feedback text-center text-sm mt-2"></div>
                </div>`;

            aiResultDiv.innerHTML = `<div class="space-y-3">
                ${createCardHTML('Hibrid Elemző (Ajánlott)', hybridResult)}
                ${createCardHTML('Odds Alapú Elemző', oddsResult)}
                ${createCardHTML('Poisson Statisztika', statisticalResult)}
                ${saveResultHTML}
            </div>`;

            const saveBtn = activePanel.querySelector('.save-result-btn');
            Object.assign(saveBtn.dataset, {
                homeTeam, awayTeam, homeOdds: home, drawOdds: draw, awayOdds: away,
                statPrediction: statisticalResult.prediction, statPredictedScore: statisticalResult.predictedScore, statPattern: statisticalResult.pattern,
                oddsPrediction: oddsResult.prediction, oddsPredictedScore: oddsResult.predictedScore, oddsPattern: oddsResult.pattern,
                hybridPrediction: hybridResult.prediction, hybridPredictedScore: hybridResult.predictedScore, hybridPattern: hybridResult.pattern,
            });
        }, 250);
    };
    
    // --- UI HELPER FUNCTIONS ---
    const addAITab = () => {
        const tabId = Date.now().toString();
        const tabCount = aiTabsContainer.children.length + 1;
        const tab = document.createElement('button');
        tab.className = 'tab px-4 py-2 text-sm font-medium border border-gray-600 rounded-t-lg -mb-px text-gray-300 shrink-0';
        tab.dataset.id = tabId;
        tab.innerHTML = `Tipp ${tabCount} <span class="close-tab ml-2 text-red-500 opacity-50 hover:opacity-100">&times;</span>`;
        const panel = document.createElement('div');
        panel.className = 'ai-tab-panel p-1';
        panel.dataset.id = tabId;
        panel.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                <input type="text" placeholder="Hazai csapat" class="ai-input ai-home-team w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" placeholder="Vendég csapat" class="ai-input ai-away-team w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <input type="text" inputmode="decimal" placeholder="Hazai (1)" class="ai-input ai-home w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" inputmode="decimal" placeholder="Döntetlen (X)" class="ai-input ai-draw w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
                <input type="text" inputmode="decimal" placeholder="Vendég (2)" class="ai-input ai-away w-full px-3 py-2 text-sm rounded-lg bg-gray-700 border border-gray-600 focus:ring-2 focus:ring-teal-400 text-white">
            </div>
            <div class="ai-result text-center font-medium pt-2 space-y-1 text-sm flex flex-col justify-center min-h-[550px]"></div>`;
        aiTabsContainer.appendChild(tab);
        aiPanelsContainer.appendChild(panel);
        switchAITab(tabId);
    };
    const switchAITab = (tabId) => {
        activeAITabId = tabId;
        aiTabsContainer.querySelectorAll('.tab').forEach(t => {
            const isActive = t.dataset.id === tabId;
            t.classList.toggle('active', isActive);
            t.style.backgroundColor = isActive ? '#1f2937' : ''; t.style.borderColor = isActive ? '#4b5563' : '#4b5563'; t.style.borderBottomColor = isActive ? '#1f2937' : '#4b5563';
        });
        aiPanelsContainer.querySelectorAll('.ai-tab-panel').forEach(p => p.classList.toggle('active', p.dataset.id === tabId));
    };
    const closeAITab = (tabId) => {
        const tab = aiTabsContainer.querySelector(`[data-id="${tabId}"]`);
        const panel = aiPanelsContainer.querySelector(`[data-id="${tabId}"]`);
        if (tab) tab.remove();
        if (panel) panel.remove();
        if (activeAITabId === tabId) {
            const firstTab = aiTabsContainer.querySelector('.tab');
            if (firstTab) switchAITab(firstTab.dataset.id); else addAITab();
        }
        aiTabsContainer.querySelectorAll('.tab').forEach((t, index) => {
            const closeSpan = t.querySelector('.close-tab');
            t.innerHTML = `Tipp ${index + 1} `; t.appendChild(closeSpan);
        });
    };
    const deleteLog = (id) => { 
        logs = logs.filter(l => l.id !== parseFloat(id)); 
        saveToLocalStorage(); 
        renderLogs(); 
    };
    
    const renderStatistics = () => {
        const modelsToTrack = ['Hibrid Elemző', 'Odds Alapú', 'Poisson Statisztika'];
        const stats = {};
        modelsToTrack.forEach(name => {
            stats[name] = { total: 0, outcomeCorrect: 0, exactScoreCorrect: 0, teams: {} };
        });

        predictionsLog.forEach(p => {
            const modelStat = stats[p.modelName]; if (!modelStat) return;
            modelStat.total++;
            if (p.outcomeCorrect) modelStat.outcomeCorrect++;
            if (p.exactScoreCorrect) modelStat.exactScoreCorrect++;
            const teams = p.teams.split(' - ');
            teams.forEach(team => {
                const teamName = team.trim();
                if (!teamName) return;
                if (!modelStat.teams[teamName]) modelStat.teams[teamName] = { total: 0, correct: 0 };
                modelStat.teams[teamName].total++;
                if (p.outcomeCorrect) modelStat.teams[teamName].correct++;
            });
        });

        const createTableHTML = (title, data) => {
            const sortedData = Object.entries(data).sort(([, a], [, b]) => b.total - a.total).slice(0, 15);
            if(sortedData.length === 0) return '';
            return `<div class="mt-4"><h4 class="font-semibold text-slate-600 mb-2">${title}</h4><div class="overflow-hidden border border-gray-200 rounded-lg"><table class="min-w-full divide-y divide-gray-200 text-sm"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left font-medium text-gray-500">Név</th><th class="px-4 py-2 text-right font-medium text-gray-500">Találat / Összes</th><th class="px-4 py-2 text-right font-medium text-gray-500">Siker (%)</th></tr></thead><tbody class="divide-y divide-gray-200 bg-white">${sortedData.map(([name, {total, correct}]) => `<tr><td class="px-4 py-2 font-medium text-gray-900">${name}</td><td class="px-4 py-2 text-right text-gray-700">${correct} / ${total}</td><td class="px-4 py-2 text-right text-gray-700 font-semibold">${((correct/total)*100).toFixed(1)}%</td></tr>`).join('')}</tbody></table></div></div>`;
        };

        let finalHTML = '';
        for (const modelName in stats) {
            const modelStat = stats[modelName];
            if (modelStat.total === 0) continue;
            const outcomeSuccessRate = ((modelStat.outcomeCorrect / modelStat.total) * 100).toFixed(1);
            const exactScoreSuccessRate = ((modelStat.exactScoreCorrect / modelStat.total) * 100).toFixed(1);
            finalHTML += `<div class="bg-slate-50 p-4 rounded-lg border"><h3 class="text-lg font-bold text-slate-800">${modelName}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2"><div><p class="text-sm text-slate-500">Kimenetel Találat</p><p class="text-2xl font-bold text-blue-600">${outcomeSuccessRate}%</p><p class="text-sm text-slate-500">(${modelStat.outcomeCorrect} / ${modelStat.total})</p></div><div><p class="text-sm text-slate-500">Pontos Eredmény</p><p class="text-2xl font-bold text-green-600">${exactScoreSuccessRate}%</p><p class="text-sm text-slate-500">(${modelStat.exactScoreCorrect} / ${modelStat.total})</p></div></div>${createTableHTML('Teljesítmény csapatok szerint', modelStat.teams)}</div>`;
        }
        statsContent.innerHTML = finalHTML || `<p class="text-center text-slate-500 py-8">Nincsenek rögzített AI tippek a statisztikához.</p>`;
    };
    
    // --- INITIALIZATION AND EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        loadFromLocalStorage();
        if (aiTabsContainer.children.length === 0) addAITab();
    });

    aiPanelsContainer.addEventListener('input', e => {
        if (e.target.classList.contains('ai-input')) {
            clearTimeout(analysisTimeout);
            const activePanel = e.target.closest('.ai-tab-panel');
            analysisTimeout = setTimeout(() => runAIAnalysis(activePanel), 500);
        }
    });

    aiPanelsContainer.addEventListener('click', e => {
        const btn = e.target.closest('.save-result-btn');
        if (btn && !btn.disabled) {
            const panel = btn.closest('.ai-tab-panel');
            const actualHomeScore = parseInt(panel.querySelector('.actual-home-score').value, 10);
            const actualAwayScore = parseInt(panel.querySelector('.actual-away-score').value, 10);
            const feedbackDiv = panel.querySelector('.result-feedback');
            if (isNaN(actualHomeScore) || isNaN(actualAwayScore)) { 
                feedbackDiv.innerHTML = `<span class="font-bold text-red-500">Kérlek add meg a valós végeredményt!</span>`;
                setTimeout(() => feedbackDiv.innerHTML = '', 3000);
                return;
            }

            const actualOutcome = (actualHomeScore > actualAwayScore) ? 'homeWin' : (actualAwayScore > actualHomeScore) ? 'awayWin' : 'draw';
            const newLog = { id: Date.now(), name: `${btn.dataset.homeTeam} - ${btn.dataset.awayTeam}`, home: parseFloat(btn.dataset.homeOdds), draw: parseFloat(btn.dataset.drawOdds), away: parseFloat(btn.dataset.awayOdds), homeScore: actualHomeScore, awayScore: actualAwayScore, outcome: actualOutcome, timestamp: new Date().toISOString() };
            logs.unshift(newLog);
            renderLogs();
            
            ['stat', 'odds', 'hybrid'].forEach(prefix => {
                const predictedScores = btn.dataset[`${prefix}PredictedScore`].split('-').map(Number);
                const modelNameMap = { stat: 'Poisson Statisztika', odds: 'Odds Alapú', hybrid: 'Hibrid Elemző' };
                predictionsLog.unshift({
                    id: Date.now() + Math.random(),
                    modelName: modelNameMap[prefix],
                    teams: `${btn.dataset.homeTeam} - ${btn.dataset.awayTeam}`,
                    pattern: btn.dataset[`${prefix}Pattern`],
                    predictedOutcome: btn.dataset[`${prefix}Prediction`],
                    predictedScore: btn.dataset[`${prefix}PredictedScore`],
                    actualScore: `${actualHomeScore}-${actualAwayScore}`,
                    outcomeCorrect: btn.dataset[`${prefix}Prediction`] === actualOutcome,
                    exactScoreCorrect: predictedScores.length === 2 && predictedScores[0] === actualHomeScore && predictedScores[1] === actualAwayScore
                });
            });
            
            saveToLocalStorage();
            feedbackDiv.innerHTML = `<span class="font-bold text-green-500">Eredmény sikeresen rögzítve!</span>`;
            btn.disabled = true;
            panel.querySelectorAll('input').forEach(i => i.disabled = true);
        }
    });
    
    addAITabBtn.addEventListener('click', addAITab);
    
    aiTabsContainer.addEventListener('click', e => {
        const tab = e.target.closest('.tab');
        if (tab && !e.target.classList.contains('close-tab')) switchAITab(tab.dataset.id);
        const closeBtn = e.target.closest('.close-tab');
        if (closeBtn) closeAITab(closeBtn.parentElement.dataset.id);
    });

    logListDiv.addEventListener('click', e => {
        const btn = e.target.closest('.delete-log-btn');
        if (btn) deleteLog(btn.dataset.id);
    });
    
    openStatsBtn.addEventListener('click', () => { renderStatistics(); statsModal.classList.remove('hidden'); });
    closeStatsBtn.addEventListener('click', () => { statsModal.classList.add('hidden'); });
    statsModal.addEventListener('click', (e) => { if (e.target === statsModal) { statsModal.classList.add('hidden'); } });
    
    const downloadFile = (data, filename, type) => {
        const blob = new Blob([data], { type });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    };

    exportJsonBtn.addEventListener('click', () => {
        const dataStr = JSON.stringify({ logs, predictionsLog }, null, 2);
        downloadFile(dataStr, 'vsport_data.json', 'application/json');
        importStatus.textContent = 'JSON adatok exportálva!';
        setTimeout(() => importStatus.textContent = '', 3000);
    });

    exportCsvBtn.addEventListener('click', () => {
        const convertToCSV = (arr, headers) => {
            const replacer = (key, value) => value === null ? '' : value;
            const headerRow = headers.join(',');
            const dataRows = arr.map(row => headers.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(',')).join('\r\n');
            return [headerRow, dataRows].join('\r\n');
        };

        if (logs.length > 0) {
            const headers = ['id', 'name', 'home', 'draw', 'away', 'homeScore', 'awayScore', 'outcome', 'timestamp'];
            downloadFile(convertToCSV(logs, headers), 'vsport_meccsek.csv', 'text/csv;charset=utf-8;');
        }
        if (predictionsLog.length > 0) {
            const headers = ['id', 'modelName', 'teams', 'pattern', 'predictedOutcome', 'predictedScore', 'actualScore', 'outcomeCorrect', 'exactScoreCorrect'];
            downloadFile(convertToCSV(predictionsLog, headers), 'vsport_tippek.csv', 'text/csv;charset=utf-8;');
        }
        importStatus.textContent = 'CSV adatok exportálva!';
        setTimeout(() => importStatus.textContent = '', 3000);
    });

    importDataBtn.addEventListener('click', () => importFileInput.click());

    importFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data.logs) && Array.isArray(data.predictionsLog)) {
                    logs = data.logs;
                    predictionsLog = data.predictionsLog;
                    saveToLocalStorage();
                    renderLogs();
                    importStatus.textContent = 'Adatok sikeresen importálva!';
                } else { throw new Error('Hibás fájlformátum.'); }
            } catch (error) {
                importStatus.textContent = `Hiba: ${error.message}`;
            } finally {
                importFileInput.value = '';
                setTimeout(() => importStatus.textContent = '', 3000);
            }
        };
        reader.readAsText(file);
    });

</script>

</body>
</html>

