<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sport Elemző - Érték-Központú Hibrid Modell</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; /* Kék betöltő */
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        textarea:focus {
            box-shadow: 0 0 0 2px #3b82f6; border-color: #3b82f6; outline: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 md:p-8">
    <div class="w-full max-w-5xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-300">AI Kvantitatív Sportelemző</h1>
            <p class="text-gray-400 mt-2">Érték-Központú Hibrid Modell (Pszichológia + Statisztika)</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- BAL OLDAL: Adatbevitel -->
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 space-y-4">
                <h3 class="text-xl font-bold text-center">1. Adatbevitel</h3>
                <div>
                    <label for="match_data" class="block text-sm font-medium text-gray-300">Meccs Adatok (Aktuális & Történelmi)</label>
                    <textarea id="match_data" rows="21" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 font-mono text-sm" placeholder="Ide illessz be minden releváns adatot.
---
Aktuális Adatok:
home_team: Juventus
away_team: Como
home_injuries: 1 kulcsjátékos (védő)
away_motivation: Kiesés elkerülése (fontosság: 1.0)
Tét: Bajnoki címért (fontosság: 0.9)
Bíró: J. Smith (4.5 lap/meccs)
Odds: 1.50, 4.00, 6.50
---
Történelmi Adatok:
Team,Season,Avg Goals For,Avg Goals Against,xG, xGA
Juventus,2023/24,1.9,0.9,1.75, 1.1
Como,2023/24,1.3,1.5,1.20, 1.4"></textarea>
                </div>
                <button id="getAnalysisBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition text-lg">Érték Keresése</button>
            </div>

            <!-- JOBB OLDAL: AI Elemzés -->
            <div class="bg-gray-800 rounded-2xl shadow-2xl p-6">
                <h3 class="text-xl font-bold text-center mb-4">2. AI Elemzési Eredmények</h3>
                <div id="analysisLoader" class="hidden flex-col justify-center items-center py-10">
                    <div class="loader"></div>
                    <div id="statusUpdate" class="mt-4 text-center text-yellow-400">Elemzés futtatása...</div>
                </div>
                <div id="analysisResult" class="hidden space-y-4">
                    <!-- Végső valószínűségek -->
                    <h4 class="font-semibold text-lg text-blue-300 mb-2">Fő Elemző AI Végeredménye (H/D/A)</h4>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <h4 class="text-sm font-semibold text-blue-300">Hazai (1)</h4>
                            <p id="prob_1" class="text-2xl font-bold"></p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-300">Döntetlen (X)</h4>
                            <p id="prob_x" class="text-2xl font-bold"></p>
                        </div>
                        <div class="bg-gray-700/50 p-3 rounded-lg">
                            <h4 class="text-sm font-semibold text-teal-300">Vendég (2)</h4>
                            <p id="prob_2" class="text-2xl font-bold"></p>
                        </div>
                    </div>
                    
                    <!-- AI Tippek -->
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h4 class="font-semibold text-lg text-blue-300 mb-2">Javasolt Tippek (Pozitív Érték alapján)</h4>
                        <div id="ai_tips_container" class="space-y-3"></div>
                    </div>

                    <!-- ÚJ BLOKK: Becsapó Modell -->
                    <div class="bg-gray-700/50 p-4 rounded-lg border-l-4 border-yellow-400">
                        <h4 class="font-semibold text-lg text-yellow-300 mb-2">"Becsapó Modell" Elemzés</h4>
                        <div id="becsapo_modell_result" class="space-y-2 text-sm">
                            <!-- Ezt a JS tölti fel -->
                        </div>
                    </div>

                    <!-- Modellek kimenetei -->
                    <div class="bg-gray-900/50 p-4 rounded-lg">
                        <h4 class="font-semibold text-lg text-blue-300">Modell-Szimulációs Eredmények</h4>
                        <div id="model_outputs" class="mt-2 text-gray-300 text-sm space-y-2"></div>
                    </div>

                    <!-- Részletes elemzés -->
                    <div class="bg-gray-900/50 p-4 rounded-lg">
                        <h4 class="font-semibold text-lg text-blue-300">Hibrid Érték-Elemzés (Kontextus + Számítás)</h4>
                        <p id="detailed_analysis" class="mt-2 text-gray-300 whitespace-pre-wrap"></p>
                    </div>
                </div>
                <div id="analysisError" class="hidden mt-4 text-center bg-red-900/50 text-red-300 p-4 rounded-lg"></div>
            </div>
        </div>
    </div>

<script>
    // --- API KULCS ÉS VÉGPONT BEÁLLÍTÁSA ---
    // A felhasználó által frissített OpenAI API kulcs.
    // FIGYELEM: A kulcsot ne tedd közzé nyilvánosan!
    const OPENAI_API_KEY = "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"; 
    const API_URL = "https://api.openai.com/v1/chat/completions"; // OpenAI végpont
    const MODEL_NAME = "gpt-4o"; // A legmegfelelőbb modell komplex analízishez
    const TIMEOUT_SECONDS = 90;

    document.getElementById('getAnalysisBtn').addEventListener('click', runFullAnalysis);
    
    // Segédfüggvény a Base64-es dekódoláshoz (nem használjuk, de meghagyva)
    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // --- (1): Numerikus előfeldolgozás ---
    // Egyszerű odds-ból valószínűség számítás a frontenden (VIG levonással)
    function calculateMarketProbabilities(oddsString) {
        try {
            const parts = oddsString.split(',').map(s => s.trim());
            if (parts.length < 3) return null; // Nem 1X2 odds

            const [odd1, oddx, odd2] = parts.map(Number);
            if (isNaN(odd1) || isNaN(oddx) || isNaN(odd2) || odd1 <= 0 || oddx <= 0 || odd2 <= 0) {
                return null;
            }

            const total = (1/odd1) + (1/oddx) + (1/odd2);
            // VIG (overround) levonása a valós valószínűségek becsléséhez
            return {
                p1: (1/odd1) / total,
                px: (1/oddx) / total,
                p2: (1/oddx) / total,
                vig: (total - 1) * 100 // Piac árrése %-ban
            };
        } catch (e) {
            console.warn("Nem sikerült az odds-okat feldolgozni:", e.message);
            return null;
        }
    }

    // --- (2): GPT Válasz Validátor ---
    function validateProbabilities(data) {
        const keys = ['Valoszinuseg_1', 'Valoszinuseg_X', 'Valoszinuseg_2'];
        for (const key of keys) {
            // Ellenőrizzük, hogy létezik-e, szám-e, és 0-1 között van-e
            if (typeof data[key] !== 'number' || isNaN(data[key])) {
                console.warn(`Hiányzó vagy érvénytelen adat a ${key} mezőben. 0-ra állítva.`);
                data[key] = 0; // Alapértelmezett érték, ha hiányzik vagy NaN
            } else if (data[key] < 0 || data[key] > 1) {
                console.warn(`Érvénytelen valószínűség (${data[key]}) a ${key} mezőben. 0-1 közé szorítva.`);
                data[key] = Math.min(Math.max(data[key], 0), 1); // Clamp 0–1 közé
            }
        }
        
        // Belső modellek validálása (opcionális, de jó gyakorlat)
        if (data.ModelOutputs) {
            const modelKeys = ['Over_2_5_Prob', 'BTTS_Yes_Prob'];
            for (const key of modelKeys) {
                 if (typeof data.ModelOutputs[key] !== 'number' || isNaN(data.ModelOutputs[key])) {
                      data.ModelOutputs[key] = 0;
                 } else {
                      data.ModelOutputs[key] = Math.min(Math.max(data.ModelOutputs[key], 0), 1);
                 }
            }
            if (typeof data.ModelOutputs['Expected_Corners'] !== 'number') data.ModelOutputs['Expected_Corners'] = 0;
            if (typeof data.ModelOutputs['Expected_Cards'] !== 'number') data.ModelOutputs['Expected_Cards'] = 0;
        }

        // Becsapó Modell validálása (ha létezik)
        if (data.BecsapoModell) {
            if (typeof data.BecsapoModell['PiacAltalanosHipotézise'] !== 'string') data.BecsapoModell['PiacAltalanosHipotézise'] = "N/A";
            if (typeof data.BecsapoModell['ModellEllenvetese'] !== 'string') data.BecsapoModell['ModellEllenvetese'] = "N/A";
            if (typeof data.BecsapoModell['Tipp'] !== 'string') data.BecsapoModell['Tipp'] = "N/A";
            if (typeof data.BecsapoModell['Indoklas'] !== 'string') data.BecsapoModell['Indoklas'] = "N/A";
        }


        return data;
    }


    // Exponenciális visszalépés logikája
    async function fetchWithRetry(url, options, retries = 3) {
        // ... (Ez a függvény változatlan maradt) ...
        let lastError = null;
        const numRetries = (typeof retries === 'number' && retries > 0) ? retries : 3;
        for (let i = 0; i < numRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429) {
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn('Rate limit hiba. Újrapróbálkozás ' + Math.round(delay/1000) + ' másodperc múlva...');
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
                if (!response.ok) {
                    const errorBody = await response.json().catch(() => ({})); 
                    throw new Error('API hiba (' + response.status + '): ' + (errorBody.error?.message || response.statusText));
                }
                return response;
            } catch (error) {
                lastError = error;
                if (i === numRetries - 1) {
                    break;
                }
            }
            if (i < numRetries - 1) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        const errorDetail = lastError
            ? ('Üzenet: ' + (lastError.message || lastError.toString()) + ' Típus: ' + (lastError.name || 'Ismeretlen'))
            : 'Nincs hibaüzenet.';
        throw new Error("Az AI API hívás sikertelen volt " + numRetries.toString() + " újrapróbálkozás után. Utolsó hiba részletei: " + errorDetail);
    }


    async function callGenerativeAI(prompt, systemInstruction, schema) {
        // ... (Ez a függvény változatlan maradt) ...
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_SECONDS * 1000);
        const fullSystemInstruction = systemInstruction + 
            "\n\n**A kimenet KIZÁRÓLAG egy JSON objektum legyen, amely megfelel az alábbi sémának:**\n" + 
            JSON.stringify(schema);
        try {
            const payload = {
                model: MODEL_NAME,
                messages: [
                    { role: "system", content: fullSystemInstruction },
                    { role: "user", content: prompt }
                ],
                response_format: { type: "json_object" } 
            };
            const headers = { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + OPENAI_API_KEY
            };
            const response = await fetchWithRetry(API_URL, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload),
                signal: controller.signal
            }); 
            clearTimeout(timeoutId);
            if (!response) {
                throw new Error("Az AI API hívás nem adott vissza választ (Response object is undefined). Lehetséges ok: Hálózati hiba, amit a belső újrapróbálkozás nem tudott kezelni.");
            }
            const result = await response.json();
            const content = result.choices?.[0]?.message?.content;
            if (!content) {
                throw new Error("Az AI modell nem adott vissza érvényes, JSON formátumú tartalmat.");
            }
            try {
                 return JSON.parse(content);
            } catch (parseError) {
                console.error("JSON parse hiba. A modell válasza:", content);
                throw new Error("A modell válasza nem volt érvényes JSON formátumú: " + parseError.message);
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                throw new Error('A kérés időtúllépés miatt megszakadt (' + TIMEOUT_SECONDS + ' másodperc). A szerver nem válaszolt időben.');
            }
            throw error;
        }
    }

    // --- MÓDOSÍTOTT FÜGGVÉNY ---
    async function runFullAnalysis() {
        setLoading(true);
        const fullData = document.getElementById('match_data').value.trim();
        
        if (!fullData) {
            showError("Az adatmező kitöltése kötelező!");
            return;
        }

        // 1. Odds kinyerése és feldolgozása
        let marketBaselineText = ""; // Ezt adjuk át az AI-nak
        try {
            const oddsRegex = /Odds: ([\d., ]+)/i;
            const match = fullData.match(oddsRegex);
            if (match && match[1]) {
                const oddsData = calculateMarketProbabilities(match[1]);
                if (oddsData) {
                    marketBaselineText = `
---
Kiegészítő információ a Front-Endtől (Piaci Alapvonal):
A megadott oddsok (${match[1]}) alapján a piac VIG (árrés) nélküli valószínűségei:
- Hazai (P1): ${(oddsData.p1 * 100).toFixed(1)}%
- Döntetlen (PX): ${(oddsData.px * 100).toFixed(1)}%
- Vendég (P2): ${(oddsData.p2 * 100).toFixed(1)}%
- Piaci VIG: ${oddsData.vig.toFixed(2)}%
---
Kérlek, használd ezt az alapvonalat az 'Edge/Érték' számításodhoz!
`;
                }
            }
        } catch (e) {
            console.error("Hiba az odds-ok feldolgozása közben:", e);
            // Nem állunk le, csak nem adunk át baseline-t
        }

        const statusDiv = document.getElementById('statusUpdate');
        statusDiv.textContent = 'Rejtett érték és piaci csapdák keresése...';

        try {
            // 2. Módosított hívás: Átadjuk a baseline szöveget
            const finalResult = await runMasterAnalyst(fullData, marketBaselineText);
            
            // 3. Validáció a megjelenítés előtt
            const validatedResult = validateProbabilities(finalResult);
            
            displayResult(validatedResult); // A validált adattal dolgozunk

        } catch (err) {
            console.error("Hiba a teljes analízis során:", err);
            showError(err.message || "Ismeretlen hiba történt.");
        } finally {
            setLoading(false);
        }
    }

    // --- MÓDOSÍTOTT FÜGGVÉNY (ÚJ SYSTEM INSTRUCTION ÉS SCHEMA) ---
    function runMasterAnalyst(fullData, marketBaselineText = "") { 
        
        // --- ÚJ SYSTEM INSTRUCTION (A FELHASZNÁLÓ KÉRÉSE ALAPJÁN) ---
        const systemInstruction = `
            Te egy professzionális, kvantitatív sportelemző Mester AI vagy, aki *rejtett értéket* (value) keres a piacokon. A fő feladatod, hogy azonosíts olyan meccseket, ahol a piaci oddsok (fogadóirodák) alulértékelnek egy kimenetelt, mert nem vették figyelembe a fontos *kvalitatív* vagy *pszichológiai* tényezőket.

            **Hibrid Folyamat (Érték-Központú):**
            1.  **Kvantitatív Alapvonal:** Kezdd a 'xG', 'xGA' és egyéb statisztikák elemzésével, hogy szimulálj egy nyers, statisztikai valószínűséget (Poisson-elv). Ez az alap.
            2.  **Kvalitatív Elemzés (A LEGFONTOSABB LÉPÉS):** Ez a te fő erősséged. Elemezd a kontextust:
                * **Pszichológia:** Motiváció (pl. kiesés elkerülése, bajnoki címért folytatott harc, bosszú egy korábbi meccsért), csapatmorál, edzőváltás hatása, hazai pálya nyomása vagy előnye, "derbi" hangulat.
                * **Kontextus:** Sérülések (főleg kulcsjátékosok), eltiltások, időjárás, meccs tétje (fontosság), bírói tényezők (pl. szigorú bíró -> több lap).
            3.  **Korrekció:** A kvalitatív tényezők alapján (Lépés 2) módosítsd a nyers statisztikai valószínűségeket (Lépés 1), hogy megkapd a *valós, általad becsült* valószínűségeket.
            4.  **Diszkrepancia Keresés (Érték Azonosítás):** Hasonlítsd össze a piaci oddsokat (a front-end által biztosított 'Piaci Alapvonal') a te *korrigált* (kvalitatív tényezőkkel módosított) valószínűségeddel.
            
            5.  **"Becsapó Modell" Elemzés (Piaci Pszichológia):** EZ EGY KÜLÖNLEGES ELEMZÉS.
                * Nézd meg az oddsokat. Állapítsd meg, mi a *nyilvánvaló* fogadás, amire az átlagos fogadó ("a tömeg") valószínűleg pénzt tesz (pl. a híres csapat alacsony szorzója, vagy a "mindenki ezt rakja" tipp). Ez a "csapda".
                * Vesd össze ezt a "csapda" hipotézist a te saját, mélyebb (kvalitatív/pszichológiai) elemzéseddel (Lépés 3).
                * A \`BecsapoModell\` objektumban magyarázd el, hogy a piac mit sugall (csapda), miért gondolod, hogy ez helytelen (a rejtett tényező), és mi a te ellen-javaslatod.

            6.  **Tipp Javaslat (Szigorú):** A \`Tippek\` listába KIZÁRÓLAG olyan javaslatokat tegyél, ahol:
                a) **Jelentős Értéket (Positive Edge) találtál:** A te módosított valószínűséged (\`Your_Prob\`) szignifikánsan magasabb, mint a piaci valószínűség (\`Market_Prob\`).
                b) **Magyarázd az Értéket:** Az 'Indoklas' mezőben egyértelműen fejtsd ki, hogy a piac *mit* hagyott figyelmen kívül (pl. "A piac alulbecsüli a Como motivációját a kiesés elkerülése miatt, ezért a 6.50-es oddsban (ami ~15% piaci prob.) érték van a mi 22%-os becslésünkkel szemben.").
                c) **Ne szűrj 70%-ra!** Távolítsd el a 70%-os magabiztossági megkötést. Egy 40%-os valószínűség is lehet kiváló tipp, ha az odds 3.00 (piaci valószínűség csak 33%). A lényeg az ÉRTÉK (Your_Prob > Market_Prob).
            
            A válaszod KIZÁRÓLAG egy strukturált JSON objektum legyen, minden számot 0 és 1 közötti tizedes tört formátumban adj meg.
        `;

        // --- ÚJ PROMPT ---
        const prompt = 'Elemezd a következő adatokat az ÉRTÉK-KÖZPONTÚ hibrid folyamatoddal. Koncentrálj a pszichológiai és kvalitatív tényezőkre. KÜLÖNLEGES FIGYELMET fordíts a "Becsapó Modell" elemzésre: mit rak a tömeg, és miért tévednek? Add vissza az eredményt a JSON sémának megfelelően. \n\n Adatok: \n```\n' + fullData + '\n```\n\n' + marketBaselineText;
        
        // --- MÓDOSÍTOTT JSON SCHEMA ---
        const schema = {
            type: "OBJECT",
            properties: {
                "Valoszinuseg_1": { "type": "number", "description": "A Master AI végső, súlyozott valószínűsége a Hazai (1) győzelemre (0.00-1.00)." },
                "Valoszinuseg_X": { "type": "number", "description": "A Master AI végső, súlyozott valószínűsége a Döntetlen (X) kimenetelre (0.00-1.00)." },
                "Valoszinuseg_2": { "type": "number", "description": "A Master AI végső, súlyozott valószínűsége a Vendég (2) győzelemre (0.00-1.00)." },
                "ModelOutputs": {
                    "type": "object",
                    "properties": {
                        "Over_2_5_Prob": { "type": "number", "description": "A gólmodell szimulált valószínűsége az Over 2.5 gólra (0.00-1.00)." },
                        "BTTS_Yes_Prob": { "type": "number", "description": "A gólmodell szimulált valószínűsége a BTTS (Mindkét csapat szerez gólt) Igen opcióra (0.00-1.00)." },
                        "Expected_Corners": { "type": "number", "description": "A szögletmodell szimulált várható értéke (pl. 10.2)." },
                        "Expected_Cards": { "type": "number", "description": "A lapmodell szimulált várható értéke (pl. 4.8)." }
                    },
                    "required": ["Over_2_5_Prob", "BTTS_Yes_Prob", "Expected_Corners", "Expected_Cards"]
                },
                "Tippek": {
                    "type": "array",
                    "description": "Lista a szigorúan szűrt, POZITÍV ÉRTÉKKEL (Edge) rendelkező tippekről.",
                    "items": {
                        "type": "object",
                        "properties": {
                            "Kategoria": { "type": "string", "description": "Pl. Végeredmény, Gólok, Szöglet." },
                            "Tipp": { "type": "string", "description": "A javasolt fogadás (pl. 'Como +1.5 AH' vagy 'Döntetlen (X)')." },
                            "Magabiztossag": { "type": "string", "description": "A becsült valószínűség százalékban, pl. '25%'." },
                            "Indoklas": { "type": "string", "description": "Rövid indoklás, miért van ebben érték (Value), mit hagyott figyelmen kívül a piac." }
                        },
                        "required": ["Kategoria", "Tipp", "Magabiztossag", "Indoklas"]
                    }
                },
                // --- ÚJ SCHEMA RÉSZ ---
                "BecsapoModell": {
                    "type": "object",
                    "description": "A 'Becsapó Modell' elemzése, amely a piaci pszichológiát és a rejtett értéket vizsgálja.",
                    "properties": {
                        "PiacAltalanosHipotézise": { "type": "string", "description": "Mit sugallnak az oddsok? Mire fogad a 'tömeg'?" },
                        "ModellEllenvetese": { "type": "string", "description": "Mi az a kvalitatív/pszichológiai tényező, amit a piac (és a tömeg) kihagy?" },
                        "Tipp": { "type": "string", "description": "A 'Becsapó Modell' által javasolt ellen-tipp (pl. 'Como +1.5 AH')." },
                        "Indoklas": { "type": "string", "description": "Rövid indoklás, miért ez a 'csapda' tipp." }
                    },
                    "required": ["PiacAltalanosHipotézise", "ModellEllenvetese", "Tipp", "Indoklas"]
                },
                // --- VÉGE ---
                "ReszletesElemzes": { "type": "string", "description": "A teljes, részletes kvantitatív és kontextuális elemzés összefoglalása magyar nyelven, kiemelve az érték-alapú meglátásokat." }
            },
            "required": ["Valoszinuseg_1", "Valoszinuseg_X", "Valoszinuseg_2", "ModelOutputs", "Tippek", "BecsapoModell", "ReszletesElemzes"]
        };
        
        return callGenerativeAI(prompt, systemInstruction, schema);
    }
    
    // --- UI Kezelő Függvények ---
    
    // --- MÓDOSÍTOTT FÜGGVÉNY ---
    function displayResult(data) {
        // H/D/A végső valószínűségek megjelenítése
        document.getElementById('prob_1').textContent = Math.round(data.Valoszinuseg_1 * 100) + '%';
        document.getElementById('prob_x').textContent = Math.round(data.Valoszinuseg_X * 100) + '%';
        document.getElementById('prob_2').textContent = Math.round(data.Valoszinuseg_2 * 100) + '%';
        
        // Tippek megjelenítése
        const tipsContainer = document.getElementById('ai_tips_container');
        tipsContainer.innerHTML = '';
        if (data.Tippek && data.Tippek.length > 0) {
            data.Tippek.forEach(tip => {
                const tipElement = document.createElement('div');
                tipElement.className = 'border-l-4 border-teal-400 pl-3';
                tipElement.innerHTML = `
                    <p class="text-lg font-bold text-teal-300">${tip.Tipp} <span class="text-sm font-medium text-gray-400">(${tip.Kategoria})</span></p>
                    <p class="text-sm text-gray-300">Modell valószínűsége: ${tip.Magabiztossag}</p>
                    <p class="text-xs text-gray-500 italic mt-1">${tip.Indoklas}</p>
                `;
                tipsContainer.appendChild(tipElement);
            });
        } else {
            tipsContainer.innerHTML = `<p class="text-center text-yellow-400">A Mester AI nem talált egyértelmű, pozitív értékkel bíró tippet.</p>`;
        }
        
        // --- ÚJ MEGJELENÍTÉSI RÉSZ ---
        // Becsapó Modell megjelenítése
        const becsapoContainer = document.getElementById('becsapo_modell_result');
        becsapoContainer.innerHTML = ''; // Törlés
        if (data.BecsapoModell) {
            const b = data.BecsapoModell;
            becsapoContainer.innerHTML = `
                <p class="text-gray-300"><strong class="text-yellow-300">Piaci Csapda (Hipotézis):</strong> ${b.PiacAltalanosHipotézise}</p>
                <p class="text-gray-300"><strong class="text-teal-300">Modell Ellenvetése:</strong> ${b.ModellEllenvetese}</p>
                <p class="text-lg font-bold text-white mt-2">Javaslat: ${b.Tipp}</p>
                <p class="text-xs text-gray-400 italic mt-1">${b.Indoklas}</p>
            `;
        } else {
             becsapoContainer.innerHTML = `<p class="text-center text-gray-400">A Becsapó Modell nem talált egyértelmű piaci anomáliát.</p>`;
        }
        // --- VÉGE ---

        // Részletes elemzés és Modell kimenetek megjelenítése
        document.getElementById('detailed_analysis').textContent = data.ReszletesElemzes;
        
        const modelsDiv = document.getElementById('model_outputs');
        const m = data.ModelOutputs;

        // Végrehajtjuk a valószínűségek szorzását 100-zal, kerekítjük és hozzáadjuk a %-ot a megjelenítéshez
        modelsDiv.innerHTML = `
            <p><strong>Gól Modell (O2.5):</strong> ${Math.round(m.Over_2_5_Prob * 100)}%, <strong>BTTS:</strong> ${Math.round(m.BTTS_Yes_Prob * 100)}%</p>
            <p><strong>Szöglet/Lap Modell:</strong> Várható szöglet: ${m.Expected_Corners.toFixed(1)}, Várható lap: ${m.Expected_Cards.toFixed(1)}</p>
        `;

        document.getElementById('analysisResult').classList.remove('hidden');
    }

    function setLoading(isLoading) {
        const loader = document.getElementById('analysisLoader');
        const status = document.getElementById('statusUpdate');
        loader.classList.toggle('hidden', !isLoading);
        document.getElementById('analysisError').classList.add('hidden');
        if(isLoading) {
            document.getElementById('analysisResult').classList.add('hidden');
        } else {
            status.textContent = 'Elemzés kész.';
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('analysisError');
        // Hiba javítva: template literál helyett string konkatenáció használata
        errorDiv.textContent = 'Hiba: ' + message;
        errorDiv.classList.remove('hidden');
        setLoading(false);
    }
</script>
</body>
</html>

