<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VSPORT Odds Generátor - ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .btn-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .poisson-card { border: 2px solid #38bdf8; background-color: #0c3355; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body class="text-slate-800 p-4">

    <main id="app-page" class="w-full max-w-4xl bg-white rounded-2xl shadow-lg border border-gray-200 p-6 space-y-6 mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
             <div class="text-left">
                  <h1 class="text-2xl md:text-3xl font-bold text-slate-900">VSport Odds Generátor</h1>
                  <p id="app-welcome-user" class="text-slate-500 mt-1">Bejelentkezve: <span class="font-bold text-purple-600">krisztian</span></p>
             </div>
             <div class="text-left sm:text-right space-y-2 w-full sm:w-auto">
                  <div class="flex items-center justify-start sm:justify-end space-x-2 flex-wrap gap-2">
                       <button id="export-csv-btn" class="bg-teal-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 btn-hover hover:bg-teal-700 flex items-center space-x-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        <span>Export VSPORT CSV</span>
                    </button>
                  </div>
                   <p id="export-status" class="text-xs text-gray-500 h-4 mt-2"></p>
             </div>
        </div>

        <div class="bg-purple-50 border border-purple-200 p-4 rounded-xl">
            <h2 class="text-lg font-bold text-purple-800">Váróterem Irányítása</h2>
            <p class="text-sm text-purple-600 mb-3">Itt tudod engedélyezni a belépést az előfizetőknek.</p>
            <div class="flex items-center gap-4">
                <button id="waiting-room-toggle" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg btn-hover transition-all duration-300 w-48 text-center"></button>
                <p class="text-sm font-medium">Jelenlegi állapot: <span id="waiting-room-status" class="font-bold"></span></p>
            </div>
        </div>

        <div class="bg-gray-800 text-white p-5 rounded-xl border border-gray-700 space-y-4 flex flex-col">
            <h2 class="text-lg font-semibold text-center">Monte Carlo Szimulátor</h2>
            <div id="ai-panel">
                 <button id="run-simulation-btn" class="w-full bg-sky-600 text-white font-bold py-3 px-4 rounded-lg btn-hover transition-all duration-300 text-center text-lg hover:bg-sky-700">
                    VSport Odds Generálása
                 </button>
                 <div id="ai-result" class="pt-4 min-h-[300px]"></div>
            </div>
        </div>
    </main>

<script>
// --- APP ELEMENTS ---
const appWelcomeUser = document.getElementById('app-welcome-user');
const exportCsvBtn = document.getElementById('export-csv-btn');
const exportStatus = document.getElementById('export-status');
const waitingRoomToggleBtn = document.getElementById('waiting-room-toggle');
const waitingRoomStatusSpan = document.getElementById('waiting-room-status');
const runSimulationBtn = document.getElementById('run-simulation-btn');
const aiResultDiv = document.getElementById('ai-result');

// --- APP STATE ---
let lastSimulationResult = null;

// --- MONTE CARLO SIMULATION MODEL ---
const SIMULATION_CONFIG = {
    // Alap valószínűségek a meccs kimenetelére (H-D-A)
    base_probs: { home: 0.55, draw: 0.20, away: 0.25 },
    
    // Átlagos gólok kimenetelenként {hazai gól, vendég gól}
    goal_means_by_outcome: {
        home: [2.2, 0.9],
        draw: [1.1, 1.1],
        away: [0.8, 2.0]
    },
    
    // Bukmékeri margin (pl. 0.05 = 5%)
    margin: 0.05,
    
    // Szimulált meccsek száma a pontossághoz
    n_matches: 200000
};

const SIMULATOR = {
    // Generál egy véletlen számot Poisson-eloszlás alapján (Knuth algoritmusa)
    _poissonRandom(lambda) {
        let L = Math.exp(-lambda);
        let k = 0;
        let p = 1;
        do {
            k++;
            p *= Math.random();
        } while (p > L);
        return k - 1;
    },

    run() {
        const { base_probs, goal_means_by_outcome, margin, n_matches } = SIMULATION_CONFIG;
        
        // Eredmények és piaci számlálók inicializálása
        let outcomes = { home: 0, draw: 0, away: 0 };
        let over25 = 0;
        let btts = 0;
        const correct_scores = {};

        // 1. A szimuláció futtatása
        for (let i = 0; i < n_matches; i++) {
            const rand = Math.random();
            let outcome_type;
            let means;

            // Meccs kimenetelének eldöntése a base_probs alapján
            if (rand < base_probs.home) {
                outcome_type = 'home';
                means = goal_means_by_outcome.home;
            } else if (rand < base_probs.home + base_probs.draw) {
                outcome_type = 'draw';
                means = goal_means_by_outcome.draw;
            } else {
                outcome_type = 'away';
                means = goal_means_by_outcome.away;
            }

            // Gólok generálása Poisson-eloszlással
            const home_goals = this._poissonRandom(means[0]);
            const away_goals = this._poissonRandom(means[1]);

            // Eredmények rögzítése
            if (home_goals > away_goals) outcomes.home++;
            else if (away_goals > home_goals) outcomes.away++;
            else outcomes.draw++;

            if (home_goals + away_goals > 2.5) over25++;
            if (home_goals > 0 && away_goals > 0) btts++;
            
            const score_key = `${home_goals}-${away_goals}`;
            correct_scores[score_key] = (correct_scores[score_key] || 0) + 1;
        }

        // 2. Valószínűségek és oddsok számítása
        const calculate_odds = (count) => {
            if (count === 0) return { prob: 0, fair_odd: Infinity, offered_odd: Infinity };
            const prob = count / n_matches;
            const fair_odd = 1 / prob;
            // Bukmékeri odds számítása a marginnal
            const offered_odd = 1 / (prob * (1 + margin));
            return { prob, fair_odd, offered_odd };
        };

        const results = {
            '1X2': {
                '1': calculate_odds(outcomes.home),
                'X': calculate_odds(outcomes.draw),
                '2': calculate_odds(outcomes.away)
            },
            'Over/Under 2.5': {
                'Over': calculate_odds(over25),
                'Under': calculate_odds(n_matches - over25)
            },
            'BTTS': {
                'Yes': calculate_odds(btts),
                'No': calculate_odds(n_matches - btts)
            },
            'Correct Scores': Object.entries(correct_scores)
                .map(([score, count]) => ({ score, ...calculate_odds(count) }))
                .sort((a, b) => b.prob - a.prob)
        };

        return results;
    }
};

// --- MAIN APP LOGIC ---

const runSimulation = () => {
    aiResultDiv.innerHTML = `<div class="p-4"><div class="flex items-center justify-center space-x-2 mt-2"><div class="loader"></div><span class="text-sm text-gray-400">Szimuláció fut... (${SIMULATION_CONFIG.n_matches.toLocaleString('hu-HU')} meccs)</span></div></div>`;
    runSimulationBtn.disabled = true;

    setTimeout(() => {
        const result = SIMULATOR.run();
        lastSimulationResult = result; // Eredmény mentése az exportáláshoz
        
        const createCardHTML = (result) => {
            const formatOdd = (odd) => isFinite(odd) ? odd.toFixed(2) : '-';
            const probToPercent = (p) => `${(p * 100).toFixed(2)}%`;

            return `<div class="p-4 poisson-card rounded-lg text-left space-y-4">
                <div>
                    <h4 class="font-bold text-sky-300 mb-2 text-center">Szimuláció Eredménye</h4>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-gray-900 p-2 rounded-md"><p class="text-xs text-gray-400">1 (Hazai)</p><p class="font-bold text-white text-lg">${formatOdd(result['1X2']['1'].offered_odd)}</p></div>
                        <div class="bg-gray-900 p-2 rounded-md"><p class="text-xs text-gray-400">X (Döntetlen)</p><p class="font-bold text-white text-lg">${formatOdd(result['1X2']['X'].offered_odd)}</p></div>
                        <div class="bg-gray-900 p-2 rounded-md"><p class="text-xs text-gray-400">2 (Vendég)</p><p class="font-bold text-white text-lg">${formatOdd(result['1X2']['2'].offered_odd)}</p></div>
                        <div class="bg-gray-900 p-2 rounded-md"><p class="text-xs text-gray-400">Over 2.5</p><p class="font-bold text-white text-lg">${formatOdd(result['Over/Under 2.5']['Over'].offered_odd)}</p></div>
                        <div class="bg-gray-900 p-2 rounded-md"><p class="text-xs text-gray-400">Under 2.5</p><p class="font-bold text-white text-lg">${formatOdd(result['Over/Under 2.5']['Under'].offered_odd)}</p></div>
                        <div class="bg-gray-900 p-2 rounded-md"><p class="text-xs text-gray-400">BTTS Igen</p><p class="font-bold text-white text-lg">${formatOdd(result['BTTS']['Yes'].offered_odd)}</p></div>
                    </div>
                </div>

                <div>
                    <h5 class="text-sm font-semibold text-sky-400 mb-1">Top 12 Végeredmény</h5>
                    <div class="space-y-1 text-xs">
                    ${result['Correct Scores'].slice(0, 12).map(s => `
                        <div class="grid grid-cols-3 items-center bg-gray-900 p-1.5 rounded-md">
                            <span class="font-mono text-gray-300 text-center">${s.score}</span>
                            <span class="font-bold text-white text-center">${probToPercent(s.prob)}</span>
                            <span class="font-bold text-sky-300 text-center">${formatOdd(s.offered_odd)}</span>
                        </div>`).join('')}
                    </div>
                </div>
            </div>`;
        };

        aiResultDiv.innerHTML = createCardHTML(result);
        runSimulationBtn.disabled = false;
    }, 100); // 100ms delay to allow UI update
};


// --- INITIALIZATION AND EVENT LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {
    updateWaitingRoomUI();
});

runSimulationBtn.addEventListener('click', runSimulation);

// --- Export, Import, Waiting Room functions ---

const downloadFile = (data, filename, type) => {
    const blob = new Blob([data], { type });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
};

exportCsvBtn.addEventListener('click', () => {
    if (!lastSimulationResult) {
        exportStatus.textContent = 'Először futtass egy generálást!';
        setTimeout(() => exportStatus.textContent = '', 3000);
        return;
    }

    const convertToCSV = (data) => {
        const headers = ['Eredmeny', 'Valoszinuseg (%)', 'Fair Odds', 'Kinalt Odds'];
        const rows = data.map(row => 
            [
                `'${row.score}`, // Add apostrophe to treat as text in Excel
                (row.prob * 100).toFixed(4),
                row.fair_odd.toFixed(4),
                isFinite(row.offered_odd) ? row.offered_odd.toFixed(4) : 'N/A'
            ].join(',')
        );
        return [headers.join(','), ...rows].join('\r\n');
    };

    const csvData = convertToCSV(lastSimulationResult['Correct Scores']);
    downloadFile(csvData, 'vsport_teljes_oddslista.csv', 'text/csv;charset=utf-8;');
    exportStatus.textContent = 'CSV adatok exportálva!';
    setTimeout(() => exportStatus.textContent = '', 3000);
});

// Hide unused buttons
importDataBtn.style.display = 'none';
exportJsonBtn.style.display = 'none';

// --- Waiting Room ---
const updateWaitingRoomUI = () => {
    const status = localStorage.getItem('waitingRoomStatus') || 'closed';
    if (status === 'open') {
        waitingRoomToggleBtn.textContent = 'Váróterem Zárása';
        waitingRoomToggleBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        waitingRoomToggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        waitingRoomStatusSpan.textContent = 'NYITVA';
        waitingRoomStatusSpan.classList.remove('text-red-600');
        waitingRoomStatusSpan.classList.add('text-green-600');
    } else {
        waitingRoomToggleBtn.textContent = 'Váróterem Nyitása';
        waitingRoomToggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        waitingRoomToggleBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        waitingRoomStatusSpan.textContent = 'ZÁRVA';
        waitingRoomStatusSpan.classList.remove('text-green-600');
        waitingRoomStatusSpan.classList.add('text-red-600');
    }
};
waitingRoomToggleBtn.addEventListener('click', () => {
    const currentStatus = localStorage.getItem('waitingRoomStatus') || 'closed';
    const newStatus = currentStatus === 'open' ? 'closed' : 'open';
    localStorage.setItem('waitingRoomStatus', newStatus);
    updateWaitingRoomUI();
});

</script>

</body>
</html>

